---
layout: default    
title: "SOS 2 le retour 20 ans après… Episode 0"
math: mathjax
date: 2023-11-30 16:19:20
last_modified_date: 2023-12-05 21:58:13
---


<!-- wp:paragraph -->
<p>J'explique ici la galère que c'est, en 2023, de remonter une machine susceptible de faire tourner le code d'un OS écrit en 2004. </p>
<!-- /wp:paragraph -->

<!-- wp:image {"align":"left","id":12262,"width":"384px","sizeSlug":"large","linkDestination":"media"} -->
<figure class="wp-block-image alignleft size-large is-resized"><a href="https://www.40tude.fr/wp-content/uploads/2023/11/image-1.png"><img src="https://www.40tude.fr/wp-content/uploads/2023/11/image-1-1024x574.png" alt="" class="wp-image-12262" style="width:384px"/></a></figure>
<!-- /wp:image -->

<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>Intro</strong></h2>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>Commence par lire <a href="https://www.40tude.fr/sos-2-le-retour-20-ans-apres/" target="_blank" rel="noreferrer noopener">cet article (épisode 1)</a> avant de revenir ici car j'ai écrit l'épisode 1 avant celui-ci. Ayé, t'as lu? Donc maintenant tu sais que j'ai décidé de faire du bouche-à-bouche à un code qui a une vingtaine d'année et de le faire tourner dans un setup modernisé à base de Grub2, Docker, NASM etc. </p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>So far so good... À l'issue de mon premier billet, le code de l'épisode 1 tourne et c'est le sourire aux lèvres que je m'attaque au code de l'épisode 2 de la <a href="http://sos.enix.org/fr/SOSDownload" target="_blank" rel="noreferrer noopener">saga SOS</a>. Ce dernier concerne les interruptions (exceptions et IRQ). Là aussi, ça se passe plutôt bien et assez rapidement j'ai un code qui "marchotte". Je dis "marchotte" car si les IRQ matérielles du timer sont bien prises en compte, je passe complètement à côté des exceptions (entre autres la division par 0 qui est mise en œuvre dans le code de démonstration de l'article). J'ai beau chercher je ne trouve pas... Je vois bien un ou deux trucs dans mon code mais globalement je suis sec... Finalement j'en arrive à la <em>très mauvaise idée</em> qu'il serait judicieux de remonter une machine de l'époque. Le principe serait d'y faire tourner le code "canal historique", sans y toucher du tout et de voir comment ça se passe.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Je confirme, c'était une très mauvaise idée et je m'en vais te raconter ici ce qui m'est arrivé. Je vais tout détailler mais franchement je ne te conseille pas de le refaire de ton côté. De mon point de vue, il est très intéressant et instructif de refaire tourner le code de SOS mais il vaut mieux le faire dans un setup "moderne". À toi de voir. Sur ce, allez, c'est parti...</p>
<!-- /wp:paragraph -->

<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>La méthode</strong></h2>
<!-- /wp:heading -->

<!-- wp:image {"align":"left","id":12664,"width":"125px","sizeSlug":"full","linkDestination":"media"} -->
<figure class="wp-block-image alignleft size-full is-resized"><a href="https://www.40tude.fr/wp-content/uploads/2023/11/image-38.png"><img src="https://www.40tude.fr/wp-content/uploads/2023/11/image-38.png" alt="" class="wp-image-12664" style="width:125px"/></a></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>Je ne peux pas porter le code de SOS sur une disquette. Je n'ai plus de PC avec disquette. À la maison, le seul qui accepte encore les floppy c'est un Mac Classic II mais bon, c'est une autre histoire. En plus, dans la série SOS, on ne peut utiliser des disquettes que sur les épisodes 1 et 2. Bref, ça ne vaut pas le coup. </p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Je ne peux pas porter le code sur une machine sur laquelle tourne une distribution moderne. En effet, cette dernière utilise Grub 2 comme bootloader. Or le code original de SOS n'est compatible qu'avec Grub 1 (aussi connu sous le nom Grub Legacy). En plus on est dans un contexte 64 bit, faudrait un cross-compiler... Ça ne sent pas la sérénité...</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>J'ai essayé, vraiment essayé d'utiliser une image Docker mais je me suis retrouvé rapidement face à des problèmes de version de Grub 2 vs Grub Legacy, des soucis de compilateur trop récent, des problèmes dans le Makefile qui passait plus... En plus, il y a un mixte entre l'image qui peut être de type 386 et le sous-jacent du container qui est "moderne". Là, je ne suis pas sûr de tout comprendre. Bref, j'ai essayé, j'ai passé/perdu beaucoup de temps et finalement je me dis qu'il vaut mieux émuler une configuration matérielle et logicielle "historique".</p>
<!-- /wp:paragraph -->

<!-- wp:heading {"level":3} -->
<h3 class="wp-block-heading"><strong>Note</strong> </h3>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>Compte tenu de ce que j'ai appris avec les tests ci-dessous... Un jour de pluie, je ferai peut-être un nouveau test avec une image Docker. À voir... </p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Comme je manque de PC, je vais installer une "vieille" distribution dans une machine virtuelle "vieille" qui sera émulée à l'aide de VMware Workstation 17 Player (sérieux, t'as vu la longueur du nom... Ils ont fumé quoi au marketing ?). Je décide de faire tout ça sur un host Linux sur lequel tourne une Mint 21.2 (cela ne change pas grand-chose à mon avis si on met l'émulateur VMware sur un host WIN11).</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Pour me mettre dans les conditions de l'article originel, il me faut donc une distribution Linux de l'époque. En 2004 chez Debian on avait Woody. Je suis parti avec une Lenny, qui est sortie en 2009 car, sauf erreur de ma part c'est la <a href="https://wiki.debian.org/Grub" target="_blank" rel="noreferrer noopener">dernière version de Debian qui avait un Grub 1 comme bootloader</a> (ensuite ils sont passé sur Grub 2). Je pense que tout ce qui va être expliqué ci-dessous peut s'appliquer à une version Woody mais bon, franchement, je ne souhaite pas réitérer l'expérience.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Donc jusque-là c'est simple : </p>
<!-- /wp:paragraph -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Un portable qui fonctionne sous Mint 21.2</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Installation d'un player VMware</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Installation d'une Debian Lenny en tant que VM dans le player</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>Installer VMware sur le host Mint</strong></h2>
<!-- /wp:heading -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>C'est récent, hyper facile. No problemo</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Si besoin lire <a href="https://linuxways.net/mint/how-to-install-vmware-workstation-on-linux-mint-20/" target="_blank" rel="noreferrer noopener">https://linuxways.net/mint/how-to-install-vmware-workstation-on-linux-mint-20/</a></li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>Récupérer une image ISO de Lenny</strong></h2>
<!-- /wp:heading -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li><a href="https://cdimage.debian.org/mirror/cdimage/archive/5.0.10/i386/iso-cd/" target="_blank" rel="noreferrer noopener">https://cdimage.debian.org/mirror/cdimage/archive/5.0.10/i386/iso-cd/</a></li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Choisir <code>debian-5010-i386-netinst.iso</code></li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Copie dans <code>/home/philippe/Téléchargements</code> du host Mint</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>Créer une machine virtuelle lenny</strong> </h2>
<!-- /wp:heading -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Sous VMware Player c'est évident. </li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Tout laisser par défaut sauf le disque qu'on garde en un seul fichier. </li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:image {"align":"center","id":12704,"width":"512px","sizeSlug":"full","linkDestination":"media"} -->
<figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.40tude.fr/wp-content/uploads/2023/12/settings2.png"><img src="https://www.40tude.fr/wp-content/uploads/2023/12/settings2.png" alt="" class="wp-image-12704" style="width:512px"/></a><figcaption class="wp-element-caption">Sur cette illustration comme sur les suivantes il ne faut pas hésiter à cliquer pour les agrandir</figcaption></figure>
<!-- /wp:image -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Oui, bien sûr, avant de lancer la VM, il faut faire pointer le CD de la VM vers le fichier ISO qu'on vient de récupérer.</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:image {"align":"center","id":12703,"width":"491px","sizeSlug":"full","linkDestination":"media"} -->
<figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.40tude.fr/wp-content/uploads/2023/12/settings1.png"><img src="https://www.40tude.fr/wp-content/uploads/2023/12/settings1.png" alt="" class="wp-image-12703" style="width:491px"/></a><figcaption class="wp-element-caption">Le CD pointe vers l'ISO téléchargée</figcaption></figure>
<!-- /wp:image -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Lancer la VM</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>Installation de Debian Lenny</strong></h2>
<!-- /wp:heading -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Tout laisser par défaut (<code>lenny</code> au lieu de <code>debian</code> comme nom de machine)</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Installer SANS miroir (plus rien n'est dispo depuis l'installeur). Faut appuyer sur <strong>ESC</strong> pour sauter cette étape et finir l'installation en installant le minimum minimorum. </li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:image {"align":"center","id":12706,"width":"512px","sizeSlug":"full","linkDestination":"media"} -->
<figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.40tude.fr/wp-content/uploads/2023/12/mirroir.png"><img src="https://www.40tude.fr/wp-content/uploads/2023/12/mirroir.png" alt="" class="wp-image-12706" style="width:512px"/></a></figure>
<!-- /wp:image -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>On est gentil on confirme qu'on sait (plus ou moins) ce que l'on fait</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:image {"align":"center","id":12708,"width":"512px","sizeSlug":"full","linkDestination":"media"} -->
<figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.40tude.fr/wp-content/uploads/2023/12/miroir2.png"><img src="https://www.40tude.fr/wp-content/uploads/2023/12/miroir2.png" alt="" class="wp-image-12708" style="width:512px"/></a></figure>
<!-- /wp:image -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>À la fin, on a donc un système minimum dans la VM.</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Je passe les détails mais à la fin, comme la chenille, c'est la VM qui redémarre &#x1f3b5;&#x1f3b6;.</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>Quand on est logué sur la VM lenny</strong></h2>
<!-- /wp:heading -->

<!-- wp:loos-hcb/code-block {"langType":"bash","langName":"Bash"} -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-bash" data-lang="Bash"><code>su                                          # il n&#39;y a pas encore de sudo
nano /etc/apt/sources.list</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Lire <a href="https://www.debian.org/distrib/archive" target="_blank" rel="noreferrer noopener">https://www.debian.org/distrib/archive</a></li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Mettre en commentaire ou <strong>supprimer la ligne</strong> <code>deb cdrom ...</code></li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Ajouter la ligne ci-dessous :</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:loos-hcb/code-block {"langType":"bash","langName":"Bash"} -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-bash" data-lang="Bash"><code>deb http://archive.debian.org/debian-archive/debian/ lenny main contrib non-free</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>CTRL + O pour écrire</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>CTRL + X pour quitter nano</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:image {"align":"center","id":12709,"width":"512px","sizeSlug":"full","linkDestination":"media"} -->
<figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.40tude.fr/wp-content/uploads/2023/12/nano1.png"><img src="https://www.40tude.fr/wp-content/uploads/2023/12/nano1.png" alt="" class="wp-image-12709" style="width:512px"/></a><figcaption class="wp-element-caption">Il ne faut pas prêter attention au nom de la VM (<strong>delete_me</strong>). J'ai fait des captures après coup. Remplace <strong>delete_me</strong> par <strong>lenny</strong> si besoin. </figcaption></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>On est toujours super user. Si on fait un : </p>
<!-- /wp:paragraph -->

<!-- wp:loos-hcb/code-block {"langType":"bash","langName":"Bash"} -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-bash" data-lang="Bash"><code>apt-get update</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:paragraph -->
<p>On a un message qui dit que certaines clés sont expirées</p>
<!-- /wp:paragraph -->

<!-- wp:loos-hcb/code-block {"langType":"bash","langName":"Bash"} -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-bash" data-lang="Bash"><code>KEYEXPIRED 1520281423
KEYEXPIRED 1337087218</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:paragraph -->
<p>Je n'ai pas réussi à mettre à jour les clés. Par exemple, les 2 commandes ci-dessous n'aident pas.</p>
<!-- /wp:paragraph -->

<!-- wp:loos-hcb/code-block {"langType":"bash","langName":"Bash"} -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-bash" data-lang="Bash"><code>apt-key list
apt-key adv --recv-keys --keyserver keyserver.ubuntu.com F42584E6</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Lire : <a href="https://futurestud.io/tutorials/fix-ubuntu-debian-apt-get-keyexpired-the-following-signatures-were-invalid" target="_blank" rel="noreferrer noopener">https://futurestud.io/tutorials/fix-ubuntu-debian-apt-get-keyexpired-the-following-signatures-were-invalid</a></li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Faire une recherche sur <code>KEYEXPIRED apt-key</code></li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>Installer les softs sur la VM lenny</strong></h2>
<!-- /wp:heading -->

<!-- wp:heading {"level":3} -->
<h3 class="wp-block-heading"><strong>Méthode que j'utilise finalement</strong></h3>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>On peut ne <strong>PAS</strong> changer la date de la VM et laisser <code>apt-get install</code> râler et nous demander de confirmer qu'on veut faire l'installation sans vérification (authentification).</p>
<!-- /wp:paragraph -->

<!-- wp:heading {"level":3} -->
<h3 class="wp-block-heading"><strong>Changer la date de la VM</strong>  </h3>
<!-- /wp:heading -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Lire <a href="https://stackoverflow.com/questions/29070471/gpg-error-http-archive-debian-org-lenny-updates-release-the-following-signat" target="_blank" rel="noreferrer noopener">https://stackoverflow.com/questions/29070471/gpg-error-http-archive-debian-org-lenny-updates-release-the-following-signat</a></li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Outre le fait que c'est un peu "bourrin" comme méthode il faut, en plus, se rappeler à chaque fois qu'on relance la VM de changer la date. Finalement ce n'est pas tenable. </li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Enfin bref, j'ai essayé, j'ai eu des problèmes... Je ne recommande pas. </li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:loos-hcb/code-block {"langType":"bash","langName":"Bash"} -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-bash" data-lang="Bash"><code>su
date --set &quot;2009-10-10&quot;
apt-get update
apt-get upgrade</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:heading {"level":3} -->
<h3 class="wp-block-heading"><strong>Les soft à installer</strong></h3>
<!-- /wp:heading -->

<!-- wp:loos-hcb/code-block {"langType":"bash","langName":"Bash"} -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-bash" data-lang="Bash"><code>apt-get install sudo
visudo</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Quand <code>apt-get</code> râle parce que le paquet <code>sudo</code> n'a pas été authentifié faut appuyer sur <code>o</code></li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Dans le fichier qui s'ouvre sous nano, rajouter une ligne du style <code>nom_user ALL=…</code> comme pour <code>root</code>. </li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>On sauve CTRL+O</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>On quitte CTRL+X</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:loos-hcb/code-block {"langType":"bash","langName":"Bash"} -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-bash" data-lang="Bash"><code>exit                                      # pour ne plus être root
sudo apt-get install locate
sudo updatedb</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Ce n'est peut-être pas une bonne idée que de vouloir optimiser en mettant tout dans une même commande.</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Je ne mets pas <code>-y</code> pour bien tout confirmer moi-même à chaque fois</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:loos-hcb/code-block {"langType":"bash","langName":"Bash"} -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-bash" data-lang="Bash"><code>sudo apt-get install build-essential
sudo apt-get install linux-headers-$(uname -r)
sudo apt-get install mtools
sudo apt-get install file
sudo apt-get install qemu</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>Installer les VMTools</strong></h2>
<!-- /wp:heading -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Faut le faire car je veux un répertoire partagé entre le host Mint et la VM lenny</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Menu Virtual Machine (en haut de la fenêtre) </li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Cliquer alors sur VMware Tools Installation</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Revenir dans la console de la VM lenny</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:loos-hcb/code-block {"langType":"bash","langName":"Bash"} -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-bash" data-lang="Bash"><code>sudo mount /dev/cdrom /cdrom
ls /cdrom</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>On voit <code>VMwareTools-10.0.12-14792880.tar.gz</code></li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Normalement on est dans <code>$HOME</code></li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Saisir les commandes ci-dessous :</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:loos-hcb/code-block {"langType":"bash","langName":"Bash"} -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-bash" data-lang="Bash"><code>cd
mkdir tmp
cd tmp
tar -xvf /cdrom/VMwareTools-10.0.12-14792880.tar.gz
cd vmware-tools-distrib
sudo ./vmware-install.pl</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Garder tous les choix par défaut (<code>ENTER</code>, <code>ENTER</code>...)</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Quand c'est terminé</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:loos-hcb/code-block {"langType":"bash","langName":"Bash"} -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-bash" data-lang="Bash"><code>cd
rm -rf ./tmp/vmware-tools-distrib/
sudo shutdown -h now</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>Faire une copie de la VM</strong> </h2>
<!-- /wp:heading -->

<!-- wp:heading {"textAlign":"center","level":3} -->
<h3 class="wp-block-heading has-text-align-center"><strong>--- /Z!\ Copie de la VM ---</strong></h3>
<!-- /wp:heading -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>C'est très important car en cas de plantage total de la VM on sera bien content de pouvoir repartir d'une copie. Oui, je te confirme, ça sent le vécu...</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Si la VM s'appelle <code>lenny</code> et que je m'appelle <code>philippe</code> elle est dans : <code>/home/philippe/vmware/lenny</code> (<code>~/vmware/lenny</code> pour les intimes)</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Suffit de copier le répertoire <code>lenny</code> et de le nommer <code>lenny.bak</code> par exemple</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Ne pas faire apparaître <code>lenny.bak</code> dans le player VMware</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>En cas de souci :<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>On supprime la VM lenny de VMware Workstation Player</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>On fait une copie de <code>lenny.bak</code> qu'on renomme <code>lenny</code></li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>On la fait apparaitre dans VMware Workstation Player</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Le coût par VM n'est pas énorme. 1.3 GB environ.</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list --></li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:paragraph -->
<p><strong>Ne pas passer à la suite</strong> sans avoir fait une copie. Aie confiance, crois en moi...&#x1f3b5;&#x1f3b6;</p>
<!-- /wp:paragraph -->

<!-- wp:heading {"textAlign":"center","level":3} -->
<h3 class="wp-block-heading has-text-align-center"><strong>--- /Z!\ Copie de la VM ---</strong></h3>
<!-- /wp:heading -->

<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>Installer un répertoire partagé</strong></h2>
<!-- /wp:heading -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Entre le host Mint et la VM lenny</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Dans VMware Workstation Player, clic droit sur la VM, option Virtual Machine Settings puis onglet Options</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Lors de la config je nomme le répertoire <code>shared_lenny</code> et il pointe sur le répertoire /<code>home/philippe/Documents/tmp/shared_lenny</code> du host Mint.</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>C'est un truc tout bête mais ça permet d'éditer du code avec le VSCode du host Mint plutôt qu'avec le nano de la VM lenny etc. </li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>Récupérer le code de l'article 1</strong></h2>
<!-- /wp:heading -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Relancer la VM lenny</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Sur la VM, le répertoire partagé est dans <code>/mnt/hgfs/shared_lenny</code> (c'est tellement intuitif... J'adore ce genre de truc...).</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:loos-hcb/code-block {"langType":"bash","langName":"Bash"} -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-bash" data-lang="Bash"><code>cd /mnt/hgfs/shared_lenny
wget -P ./ http://sos.enix.org/wiki-fr/upload/SOSDownload/sos-code-art1.tgz
tar -xvf sos-code-art1.tgz
cd sos-code-article1</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>Compiler le code de SOS</strong></h2>
<!-- /wp:heading -->

<!-- wp:loos-hcb/code-block {"langType":"bash","langName":"Bash"} -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-bash" data-lang="Bash"><code>make</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Pas d'erreur</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Un warning dans <code>main.c</code> ligne 32, variable <code>i</code> non utilisée. </li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>On s'en fout pour l'instant</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:paragraph -->
<p>Sur la VM lenny, si dans la console je tape :</p>
<!-- /wp:paragraph -->

<!-- wp:loos-hcb/code-block {"langType":"bash","langName":"Bash"} -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-bash" data-lang="Bash"><code>file fd.img</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:paragraph -->
<p>Alors je vois :</p>
<!-- /wp:paragraph -->

<!-- wp:loos-hcb/code-block {"langType":"bash","langName":"Bash"} -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-bash" data-lang="Bash"><code>fd.img: DOS floppy 1440k, x86 hard disk boot sector</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:paragraph -->
<p>Comme la compilation a été faite dans un répertoire partagé entre le host Mint et la VM lenny, on peut relancer la même commande <code>file fd.img</code> depuis le host. Voilà ce que l'on voit alors :</p>
<!-- /wp:paragraph -->

<!-- wp:loos-hcb/code-block {"langType":"bash","langName":"Bash"} -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-bash" data-lang="Bash"><code>fd.img: DOS/MBR boot sector, code offset 0x48+2, OEM-ID &quot;MTOO3911&quot;, root entries 224, sectors 2880 (volumes &lt;=32 MB), sectors/FAT 9, sectors/track 18, serial number 0x78a5cd31, unlabeled, FAT (12 bit), followed by FAT</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:paragraph -->
<p>Que ce soit sur le host Mint ou la VM lenny, la commande <code>file sos.elf</code> retourne la même chose : </p>
<!-- /wp:paragraph -->

<!-- wp:loos-hcb/code-block {"langType":"bash","langName":"Bash"} -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-bash" data-lang="Bash"><code>fsos.elf: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), statically linked, not stripped</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:paragraph -->
<p>Sur le host Mint, on peut monter l'image <code>fd.img</code>. Suffit de cliquer sur le nom du fichier dans "l'explorateur de fichiers" (je sais plus comment il s'appelle. Nemo ? Pas sûr...). On retrouve les sous-répertoires <code>/boot</code>, /<code>modules</code>, /<code>system</code>. Dans <code>/system</code> il y a <code>sos.elf</code>. </p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>On peut aussi monter <code>fd.img</code> depuis la VM lenny</p>
<!-- /wp:paragraph -->

<!-- wp:loos-hcb/code-block {"langType":"bash","langName":"Bash"} -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-bash" data-lang="Bash"><code>sudo mkdir /media/tmp_dsk
sudo mount -o loop fd.img /media/tmp_dsk
ls -al /media/tmp_dsk</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:paragraph -->
<p>On retrouve bien le contenu du floppy</p>
<!-- /wp:paragraph -->

<!-- wp:loos-hcb/code-block {"langType":"bash","langName":"Bash"} -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-bash" data-lang="Bash"><code>sudo umount /media/tmp_dsk</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>Lancement</strong></h2>
<!-- /wp:heading -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>On est toujours dans le répertoire <code>/mnt/hgfs/shared_lenny/sos-code-article1</code></li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:loos-hcb/code-block {"langType":"bash","langName":"Bash"} -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-bash" data-lang="Bash"><code>qemu -fda fd.img</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>On a une erreur du type :</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:loos-hcb/code-block {"langType":"bash","langName":"Bash"} -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-bash" data-lang="Bash"><code>Use fbdev option or set FRAMEBUFFER environment variable</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Il faudrait peut-être que je creuse la question après avoir lu ça par exemple : <a href="https://linux.debian.user.narkive.com/HxaW9M7S/fbdev-requirement-of-qemu" target="_blank" rel="noreferrer noopener">https://linux.debian.user.narkive.com/HxaW9M7S/fbdev-requirement-of-qemu</a></li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Normalement SOS fonctionne avec la mémoire vidéo qui est mappée en mémoire (0xB8000, 80x25x2).</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Bon allez, on relance en évitant le frame buffer</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:loos-hcb/code-block {"langType":"bash","langName":"Bash"} -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-bash" data-lang="Bash"><code>qemu --curses -fda fd.img</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>On voit Grub Ver 0.97 tout en haut de l'écran et le menu Simple OS (c'est rassurant, c'est la preuve qu'on est  en Grub 1).</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Après sélection de SOS dans le menu ça part en vrille</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:loos-hcb/code-block {"langType":"bash","langName":"Bash"} -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-bash" data-lang="Bash"><code>Booting &#39;Simple OS&#39;
root (fd0)
Filesystem type is fat, using whole disk
kernel /system/sos.elf
Error 13 : Invalid or unsupported executable format
Press any key to continue...</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Là, c'est mort</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Sur la VM, il faut ouvrir un second terminal (ALT+F2)</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Se loguer</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Saisir</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:loos-hcb/code-block {"langType":"bash","langName":"Bash"} -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-bash" data-lang="Bash"><code>top</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Appuyer sur '<code>k</code>'</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Donner le N° du PID de qemu puis saisir '9' pour le type de signal à envoyer</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>C'est équivalent à la commande : <code>kill -9 2684  # où 2684 est le PID de qemu</code></li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:image {"align":"right","id":12670,"width":"256px","sizeSlug":"full","linkDestination":"media"} -->
<figure class="wp-block-image alignright size-full is-resized"><a href="https://www.40tude.fr/wp-content/uploads/2023/11/image-39.png"><img src="https://www.40tude.fr/wp-content/uploads/2023/11/image-39.png" alt="" class="wp-image-12670" style="width:256px"/></a></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>Bon, ben, "ça passe pas...". Va falloir trouver autre chose. </p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Je pensais avoir trouvé un truc grâce à ce lien :</p>
<!-- /wp:paragraph -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li><a href="https://stackoverflow.com/questions/27939316/bochs-2-4-6-grub-0-97-error-13-invalid-or-unsupported-executable-format-wh" target="_blank" rel="noreferrer noopener">https://stackoverflow.com/questions/27939316/bochs-2-4-6-grub-0-97-error-13-invalid-or-unsupported-executable-format-wh</a></li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:paragraph -->
<p>Dans <code>sos.ldS</code> je déplace <code>*(.rodata)</code> dans la section <code>.text</code> du code. </p>
<!-- /wp:paragraph -->

<!-- wp:loos-hcb/code-block -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-plain"><code>/* Beginning of the text section */
    .text ALIGN(4096) :
    {  
        /* This section includes the code */
        *(.text*)
        *(.rodata*)
        /* Defines the &#39;etext&#39; and &#39;_etext&#39; at the end */
        PROVIDE(etext = .);
        PROVIDE(_etext = .);
    }
    /* Beginning of the data section */
    .data . :
    {   *(.data*)
        PROVIDE(edata = .);
        PROVIDE(_edata = .);
    }
    /* Beginning of the read-only data section */
    /*
    .rodata . :
    {   *(.rodata*)
        PROVIDE(erodata = .);
        PROVIDE(_erodata = .);
    }
    */</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:paragraph -->
<p>Dans le même fichier je modifie ensuite la ligne :</p>
<!-- /wp:paragraph -->

<!-- wp:loos-hcb/code-block -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-plain"><code>.bss SIZEOF(.rodata) + ADDR(.rodata) :</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:paragraph -->
<p>Qui devient : </p>
<!-- /wp:paragraph -->

<!-- wp:loos-hcb/code-block -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-plain"><code>.bss SIZEOF(.data) + ADDR(.data) :</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:paragraph -->
<p>En effet, il n'y a plus de section <code>.rodata</code>. Je relance</p>
<!-- /wp:paragraph -->

<!-- wp:loos-hcb/code-block -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-plain"><code>make clean
make
qemu --curses -fda fd.img</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:paragraph -->
<p>Mais, bon, "ça passe toujours pas...". De toute façon c'était une bêtise. Le code original tournait. De plus, à mon avis, cette histoire de <code>.rodata</code> n'est valable <strong>QUE</strong> si le code assembleur est assemblé par NASM. Je pense même que NASM supporte pleinement <code>.rodata</code> (depuis la version 0.98.32, pour le format elf, voir <a href="https://www.nasm.us/docs.php" target="_blank" rel="noreferrer noopener">le pdf de NASM 2.16.01 p175</a>). Bon, on s'en fout, on perd du temps là... En effet, sous SOS, le code assembleur historique est assemblé par GAS qui gère très bien les sections <code>.rodata</code>. Et, encore une fois, le code original fonctionnait très bien...</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>J'enlève les modifications de <code>sos.ldS</code> puis je repars carrément de zéro en décompressant l'article 1 à nouveau.</p>
<!-- /wp:paragraph -->

<!-- wp:loos-hcb/code-block {"langType":"bash","langName":"Bash"} -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-bash" data-lang="Bash"><code>rm -rf sos-code-article1/
tar -xvf sos-code-art1.tgz</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:paragraph -->
<p>Mouai... Et on fait quoi maintenant qu'on est revenu au point de départ ?</p>
<!-- /wp:paragraph -->

<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>Follow the white rabbit...</strong></h2>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>Heu... Je vais te calmer tout de suite. On ne va pas aller aux pays des merveilles mais plutôt à la cave... Et encore, je vais te donner une version édulcorée, un truc bien propre, à la chronologie bien linéaire, genre tuto de YouTube où tout se passe toujours bien. </p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>En réalité ça ne s'est pas du tout passé comme ça. C'est parti dans tous les sens, j'ai pas mal cherché, j'ai fait les trucs dans le mauvais ordre, j'ai perdu pas mal de VM... Une vraie boucherie, y avait du sang partout. Le genre d'expérience qui te donne envie de tout jeter. Un peu comme les ces p&#x1f480;t@ins de randos qui n'en finissent pas de monter...</p>
<!-- /wp:paragraph -->

<!-- wp:embed {"url":"https://www.youtube.com/shorts/d92jbkVY8wY","type":"video","providerNameSlug":"youtube","responsive":true,"className":"wp-embed-aspect-16-9 wp-has-aspect-ratio"} -->
<figure class="wp-block-embed is-type-video is-provider-youtube wp-block-embed-youtube wp-embed-aspect-16-9 wp-has-aspect-ratio"><div class="wp-block-embed__wrapper">
https://www.youtube.com/shorts/d92jbkVY8wY
</div></figure>
<!-- /wp:embed -->

<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>Ce que je crois avoir compris</strong></h2>
<!-- /wp:heading -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>SOS fonctionne avec Grub 1</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Dans la configuration actuelle, avec le Grub 1 installé sur la VM lenny, le Makefile retrouve bien ses petits mais ça part en vrille à l'exécution. Message du style "Invalid or unsupported executable format".</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>En cherchant sur le web, je fini par fouiller, à la main, message par message, dans les <a href="http://the-doors.enix.org/pipermail/sos/">archives de la mailing </a><a href="http://the-doors.enix.org/pipermail/sos/" target="_blank" rel="noreferrer noopener">l</a><a href="http://the-doors.enix.org/pipermail/sos/">ist de SOS</a> (merci les gars, franchement merci de tout laisser en ligne après autant d'années) </li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Plus précisément, je tombe sur ce message : <a href="http://the-doors.enix.org/pipermail/sos/2011-January/001076.html" target="_blank" rel="noreferrer noopener">http://the-doors.enix.org/pipermail/sos/2011-January/001076.html</a>. Là, tu te dis qu'il y a des mecs qui ont plus d'idées que toi et qu'il y a peut-être un truc à tenter.</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Du coup je recompile un Grub 1 et je l'installe sur la VM lenny</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Ensuite je recompile SOS. Ça génère un nouveau fichier fd.img en utilisant, entre autres, le fichier Stage 2 du "nouveau" Grub 1</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Et là... Ça ne marche toujours pas... P&#x1f480;t@in fait suer !!!</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Grand moment de solitude... Pas le moral... Je tombe dans l'alcool, la drogue et la prostitution...</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Mais bon, en continuant à chercher je trouve ce billet : <a href="https://wiki.archlinux.org/title/Talk:GRUB_Legacy">https://wiki.archlinux.org/title/Talk:GRUB_Legacy</a></li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:image {"align":"right","id":12735,"width":"128px","sizeSlug":"full","linkDestination":"media"} -->
<figure class="wp-block-image alignright size-full is-resized"><a href="https://www.40tude.fr/wp-content/uploads/2023/12/image.png"><img src="https://www.40tude.fr/wp-content/uploads/2023/12/image.png" alt="" class="wp-image-12735" style="width:128px"/></a></figure>
<!-- /wp:image -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Là, tu comprends que pour Grub 1, il faut que les <a href="https://fr.wikipedia.org/wiki/N%C5%93ud_d%27index" target="_blank" rel="noreferrer noopener">inodes du système de fichiers</a> aient une taille de 128 octets.</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Bien sûr, quand je vérifie la taille des inodes de la VM lenny je découvre qu'ils ont une taille de 256 octets. C'est bizarre et contradictoire avec ce qui est dit dans le billet mais bon... On va quand même essayer de mettre les inodes à 128 octets.</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Le problème c'est que je ne peux pas changer la taille des inodes sur un disque qui est monté</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Je récupère une distribution qui possède un mode "live". </li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Je boote la VM lenny sur le CD de la distribution live en question</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Je vérifie la taille des inodes. Ils sont à 256 bytes.</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Je demande à les faire passer à 128...</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Et là on me dit que ce n'est pas possible de réduire la taille des inodes qu'on ne peut que les faire grandir</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>P&#x1f480;t@in, je suis maudit ou quoi ?</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Re alcool, re drogue et re prostitution...</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>J'essaie de jouer avec l'installeur de la Debian Lenny. J'essaie le mode expert mais là il y a trop de questions auxquelles je n'ai pas les réponses. Je pense cependant qu'un "bon" aurait choisi cette voie. </li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Finalement je fais un entre-deux un peu "cracra". Accroche ta ceinture et reste avec moi deux minutes. Imagine... :<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Je boote le live CD sur la VM leny</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Cette dernière a toutes ses partitions, tout va bien. Y a juste la première dont il faut faire passer la taille des inodes de 256 à 128 octets</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>On sacrifie la première partition en claquant dessus un nouveau système de fichiers dont les inodes ont une taille de 128. Ça ne va sans doute pas matcher au niveau de la taille de la partition mais on s'en fout on est plus à ça près. </li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Par contre, c'est sûr, on aura perdu tous les fichiers. </li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Faut donc refaire une installation de la Debian Lenny</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Je reboote donc la VM lenny avec le CD d'installation de la Debian Lenny</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Lors du paramétrage de l'installation on demande à garder les partitions ainsi que les systèmes de fichiers en place et à simplement copier les fichiers de Lenny dessus</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Enfin je reboote la VM lenny. </li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Tout devrait être pareil sauf que dorénavant, les inodes de sda1 devraient être à 128 octets.</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list --></li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Pour faire bonne mesure, je recompile un Grub 1 et je le réinstalle</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Je reboote de la VM lenny</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Je compile et je teste SOS </li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Et si ça ne marche pas... Ben je ne sais pas... J'élève des brebis sur les hauteurs de <a href="https://www.sarisolenzara.fr/" target="_blank" rel="noreferrer noopener">Solenzara </a>? </li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:paragraph -->
<p>Mouai... Ça a l'air compliqué ton affaire. Tu peux résumer ?</p>
<!-- /wp:paragraph -->

<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>La check-list qu'on va suivre</strong></h2>
<!-- /wp:heading -->

<!-- wp:list {"ordered":true} -->
<ol><!-- wp:list-item -->
<li>Récupérer une distribution "live" et booter dessus</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Créer un système de fichiers avec des inodes à 128 octets sur le sda1 de la VM</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Rebooter la VM sur le CD d'installation Debian Lenny</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Refaire une installation en conservant les systèmes de fichiers en place</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Rebooter la VM, compiler et installer Grub 1</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Rebooter la VM, compiler et tester SOS</li>
<!-- /wp:list-item --></ol>
<!-- /wp:list -->

<!-- wp:paragraph -->
<p>Ca a l'air tellement facile, tellement naturel quand c'est résumé de cette façon...</p>
<!-- /wp:paragraph -->

<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>1 - Récupérer une distribution live et booter dessus</strong></h2>
<!-- /wp:heading -->

<!-- wp:list {"ordered":true} -->
<ol><!-- wp:list-item -->
<li>Après coup je pense que j'aurai pu prendre une BusyBox, une ToyBox où un truc de ce genre. Sur le moment je n'ai pas réfléchi, j'ai fait simple et j'ai récupéré une <a href="https://www.linuxmint.com/edition.php?id=307" target="_blank" rel="noreferrer noopener">Mint XFCE</a> parce que c'est pas trop lourd, que je sais qu'il y a <code>gparted</code> etc. </li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Je la dépose dans le répertoire <code>/home/philippe/Téléchargements</code> du host Mint</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Je fais une copie du répertoire <code>/home/philippe/vmware/lenny</code> que je renomme <code>/home/philippe/vmware/lenny128</code> (128 comme les 128 octets des inodes. Malin le mec &#x1f98a;)  </li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Je fais apparaître cette VM dans VMware Player (un clic sur home puis "Open a Virtual Machine" à droite). </li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Dans les settings je fais passer la mémoire à 4GB et je fais pointer le CD sur l'ISO de Mint XFCE. </li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>J'en profite pour créer un répertoire partagé que je nomme <code>shared-lenny128</code>. Sur le host Mint il pointe sur /<code>home/philippe/Documents/tmp/shared_lenny128</code></li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Au démarrage de la VM je confirme que j'ai copié la VM (c'est pour des histoires de duplication d'adresse MAC, je sais plus trop).</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Concernant le démarrage sur le CD live il faut, quand la VM boote, appuyer sur la touche <code>F2</code> pour accèder à son BIOS. Là, dans l'onglet boot du BIOS, il faut mettre le CD en haut de la liste, quitter le BIOS et reprendre le démarrage de la VM. </li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>On se retrouve sur une Mint XFCE live </li>
<!-- /wp:list-item --></ol>
<!-- /wp:list -->

<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>2 - Créer un système de fichiers avec des inodes à 128 octets sur le sda1 de la VM</strong></h2>
<!-- /wp:heading -->

<!-- wp:list {"ordered":true} -->
<ol><!-- wp:list-item -->
<li>J'utilise l'excellent <code>gparted</code> de la Mint live et je vérifie les différentes partitions du disque ainsi que le nom de ce dernier. Ici c'est sda, la partition swap est sur sda5 et le système de fichiers sur sda1</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Dans un terminal, pour vérifier la taille des inodes je tape : <code>sudo tune2fs -l /dev/sda1</code></li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Dans tout ce qui est affiché je vois un truc du style : <code>Inode size 256</code></li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Pour vérifier la taille des inodes on peut aussi faire un <code>cat /etc/mk2fs.conf | more</code></li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Ca va pas marcher mais on peut tenter : <code>sudo tune2fs -I 128 /dev/sda1</code></li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>C'est là qu'il répond : <code>tune2fs 1.46.5 (30 Dec 2020) Shrinking inode size not supported</code></li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Pas de remord, on pas trop d'autre solution. On créé un nouveau système de fichiers sur la partition sda1 avec : <code>sudo mke2fs -t ext3 -I 128 /dev/sda1</code></li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>On éteint gentiment la VM (<code>sudo shutdown -h now</code>) et on revient sur le VMware Player</li>
<!-- /wp:list-item --></ol>
<!-- /wp:list -->

<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>3 - Rebooter la VM sur le CD d'installation Debian Lenny</strong></h2>
<!-- /wp:heading -->

<!-- wp:list {"ordered":true} -->
<ol><!-- wp:list-item -->
<li>Dans le VMware Player je m'assure que le CD de la VM lenny128 pointe bien sur l'ISO <code>debian-5010-i386-netinst.iso</code></li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>On redémarre la VM</li>
<!-- /wp:list-item --></ol>
<!-- /wp:list -->

<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>4 - Refaire une installation en conservant les systèmes de fichiers en place</strong></h2>
<!-- /wp:heading -->

<!-- wp:list {"ordered":true} -->
<ol><!-- wp:list-item -->
<li>On commence à avoir l'habitude</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Je laisse tout par defaut sauf que je nomme la machine lenny128</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Le truc le plus important c'est l'étape partition/système de fichiers. Faut lui faire comprendre qu'on garde le partitionnment et le système de fichiers qui est en place</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>On passe à la suite et il copie les fichiers</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>L'installation se termine normalement</li>
<!-- /wp:list-item --></ol>
<!-- /wp:list -->

<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>5 - Rebooter la VM, compiler et installer Grub 1</strong></h2>
<!-- /wp:heading -->

<!-- wp:list {"ordered":true} -->
<ol><!-- wp:list-item -->
<li>Une fois que la VM lenny128 a démarré, je tape <code>sudo tune2fs -l /dev/sda1</code> dans un terminal</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Je dois voir un truc du style <code>Inode size : 128</code>. Si je n'ai pas cette valeur, c'est pas la peine d'aller plus loin. Il faut revenir en arrière. </li>
<!-- /wp:list-item --></ol>
<!-- /wp:list -->

<!-- wp:heading {"level":3} -->
<h3 class="wp-block-heading"><strong>5.1 - Compiler Grub 1</strong></h3>
<!-- /wp:heading -->

<!-- wp:loos-hcb/code-block -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-plain"><code>sudo nano /etc/apt/sources.lst</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Ajouter la ligne</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:loos-hcb/code-block -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-plain"><code>deb-src http://archive.debian.org/debian-archive/debian/ lenny main </code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Sauver, quitter. Normalement il y a un répertoire <code>tmp</code> dans <code>$HOME</code></li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:loos-hcb/code-block -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-plain"><code>sudo apt-get update
cd ~/tmp
mkdir grub_build
cd grub_build
apt-get source grub
cd grub-0.97</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Allez, on compile et on installe. <br>Pas de panique ça va bien se passer. En fait on a déjà téléchargé tout ce dont a besoin (rappelle toi le <code>sudo apt-get install build-essential</code> par exemple). <br>Ensuite le make install ne va rien installer sur l'installation déjà en place. En fait tous les fichiers générés vont se retrouver dans <code>/usr/local</code>. Donc, encore une fois, pas de panique.   </li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:loos-hcb/code-block -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-plain"><code>./configure
make                    # jette ton œil
make -n install         # jette ton œil, vérifie que tout semble OK
sudo make install
</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Quand c'est terminé et que tout semble s'être bien passé</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:loos-hcb/code-block -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-plain"><code>ls -al /usr/local/sbin
ls -al /usr/local/lib/grub/i386-pc</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>À titre d'exercice je te propose de comparer les tailles, les dates et les heures des fichiers <code>stage2</code> des répertoires <code>/boot/grub</code> et <code>/usr/local/lib/grub/i386-pc</code>. </li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Moi j'ai respectivement 128 552 octets d'un côté et 101 978 de l'autre. </li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Ce qu'il faut qu'on fasse maintenant c'est qu'on installe notre Grub 1 nouvellement compilé en lieu et place de celui qui est venu avec la Debian Lenny.</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>On vérifie le petit nom de notre disque avec cette commande par exemple</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:loos-hcb/code-block -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-plain"><code>sudo fdisk -l</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Moi je vois <code>sda1</code>… <code>sda5</code>. Mon disque s'appelle <code>sda</code>. </li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Ensuite j'installe le nouveau Grub1.</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:loos-hcb/code-block -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-plain"><code>cd /usr/local/sbin
sudo ./grub-install /dev/sda</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Aucune erreur à l'écran normalement. </li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Si c'est pas le cas on est mal... </li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Dans <code>/boot/grub</code> je vois que la taille de stage2 est dorénavant 101 978. </li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>On reboote</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:loos-hcb/code-block -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-plain"><code>sudo reboot -h now</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:heading {"level":3} -->
<h3 class="wp-block-heading"><strong>5.2 À lire si besoin</strong></h3>
<!-- /wp:heading -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li><a href="https://www.gnu.org/software/grub/manual/grub/html_node/Installing-GRUB-using-grub_002dinstall.html" target="_blank" rel="noreferrer noopener">https://www.gnu.org/software/grub/manual/grub/html_node/Installing-GRUB-using-grub_002dinstall.html</a></li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li><a href="https://www.cyberciti.biz/faq/how-to-get-source-code-of-package-using-the-apt-command-on-debian-or-ubuntu/" target="_blank" rel="noreferrer noopener">https://www.cyberciti.biz/faq/how-to-get-source-code-of-package-using-the-apt-command-on-debian-or-ubuntu/</a></li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li><a href="https://www.malekal.com/comment-compiler-un-logiciel-depuis-des-sources-sur-linux/" target="_blank" rel="noreferrer noopener">https://www.malekal.com/comment-compiler-un-logiciel-depuis-des-sources-sur-linux/</a></li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>6 - Rebooter la VM, compiler et tester SOS</strong></h2>
<!-- /wp:heading -->

<!-- wp:heading {"level":3} -->
<h3 class="wp-block-heading"><strong>6.1 Article 1 de SOS</strong></h3>
<!-- /wp:heading -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Oups... On a déjà rebooté. <br>Tiens, vas-y, fais moi un procès si t'es pas content.</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>On récuprère ensuite le code de l'article 1 de SOS. </li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:loos-hcb/code-block -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-plain"><code>cd /mnt/hgfs/shared_lenny128
wget -P ./ http://sos.enix.org/wiki-fr/upload/SOSDownload/sos-code-art1.tgz 
tar -xvf sos-code-art1.tgz
cd sos-code-article1
</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Comme on a recompilé Grub 1 je te propose de mettre à jour les variables <code>grub_dirs_common</code> et <code>sbin_grub_path</code> du fichier <code>../sos-code-article1/support/build-image.sh</code> comme suit :  </li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:loos-hcb/code-block -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-plain"><code># grub_dirs_common= .................
# sbin_grub_path= .................

grub_dirs_common=&quot;/usr/local/lib/grub/i386-pc&quot;
sbin_grub_path=&quot;/usr/local/sbin&quot;
</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Quand c'est fait on build. </li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Il ne doit pas y avoir d'erreur. Il y a juste un warning à propos d'une variable <code>i</code> qui n'est pas utilisée dans <code>main.c</code>.</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:loos-hcb/code-block -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-plain"><code>make</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>On boote SOS dans QEMU</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Note que je demande à l'émulateur QEMU de simuler une machine avec 256 MB de RAM mais bon on s'en fout... </li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Oh, p&#x1f480;t@in ça démarre enfin ! </li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:loos-hcb/code-block -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-plain"><code>qemu -m 256M --curses -fda fd.img</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:image {"align":"center","id":12695,"width":"512px","sizeSlug":"full","linkDestination":"media"} -->
<figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.40tude.fr/wp-content/uploads/2023/12/article1.png"><img src="https://www.40tude.fr/wp-content/uploads/2023/12/article1.png" alt="" class="wp-image-12695" style="width:512px"/></a></figure>
<!-- /wp:image -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Je pense que les problèmes d'affichage sont liés au fait que QEMU est en mode "curses" (ça ressemble à Rhide et à l'interface graphique qu'avait <a href="https://winworldpc.com/product/borland-turbo-c/2x" target="_blank" rel="noreferrer noopener">Turbo C 2.0</a>) et que cela ne correspond pas exactement à la représentation que SOS se fait de la mémoire vidéo. </li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Faut regarder dans le détail. Je ne suis pas sûr de tout comprendre. </li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Mais... Nom de Zeus, Marty, il a démarré !</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:paragraph -->
<p>Pour sortir proprement, il faut :</p>
<!-- /wp:paragraph -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Ouvrir un second terminal (ALT+F2)</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Se loguer</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Saisir la commande <code>top</code></li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Appuyer sur '<code>k</code>'</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Donner le N° du PID de qemu puis saisir '9' pour le type de signal à envoyer</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:heading {"level":4} -->
<h4 class="wp-block-heading"><strong>6.1.1 À lire si besoin</strong></h4>
<!-- /wp:heading -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li><a href="https://fr.wikipedia.org/wiki/Ncurses#:~:text=ncurses%20(de%20l'anglais%20%C2%AB,'un%20mode%20semi%2Dgraphique." target="_blank" rel="noreferrer noopener">https://fr.wikipedia.org/wiki/Ncurses#:~:text=ncurses%20(de%20l'anglais%20%C2%AB,'un%20mode%20semi%2Dgraphique.</a></li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li><a href="https://arnaud-feltz.developpez.com/tutoriels/ncurses/?page=premier_pas" target="_blank" rel="noreferrer noopener">https://arnaud-feltz.developpez.com/tutoriels/ncurses/?page=premier_pas</a></li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:heading {"level":3} -->
<h3 class="wp-block-heading"><strong>6.2 Article 2 de SOS</strong></h3>
<!-- /wp:heading -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Je te la fais courte</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:loos-hcb/code-block -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-plain"><code>cd /mnt/hgfs/shared_lenny128
wget -P ./ http://sos.enix.org/wiki-fr/upload/SOSDownload/sos-code-art2.tgz 
tar -xvf sos-code-art2.tgz
cd sos-code-article2</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Mise à jour des variables <code>grub_dirs_common</code> et <code>sbin_grub_path</code> du fichier <code>../sos-code-article1/support/build-image.sh</code>.  </li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:loos-hcb/code-block -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-plain"><code># grub_dirs_common= .................
# sbin_grub_path= .................

grub_dirs_common=&quot;/usr/local/lib/grub/i386-pc&quot;
sbin_grub_path=&quot;/usr/local/sbin&quot;
</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Build et run</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:loos-hcb/code-block -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-plain"><code>make
qemu -m 256M --curses -fda fd.img</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Voilà ce que je vois.</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:image {"align":"center","id":12696,"width":"512px","sizeSlug":"full","linkDestination":"media"} -->
<figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.40tude.fr/wp-content/uploads/2023/12/article2.png"><img src="https://www.40tude.fr/wp-content/uploads/2023/12/article2.png" alt="" class="wp-image-12696" style="width:512px"/></a><figcaption class="wp-element-caption">Clique sur l'image et compte le nombre de carrés rouge. Y en a combien ? 32, comme les 32 bits du compteur.</figcaption></figure>
<!-- /wp:image -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Comme dans l'article 2 on retrouve des marques rouges à gauche pour les exceptions liées aux divisions par 0. </li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Cependant, je ne retrouve pas à droite les marques vertes qui comptent les IRQ matérielles du timer qui tourne à 100 Hz. </li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>M'en fout. Je suis trop content, je regarderai ça plus tard. Je suis presque sûr que c'est un problème d'affichage, de maping mémoire... </li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:heading {"level":3} -->
<h3 class="wp-block-heading"><strong>6.3 Article 2 de SOS, bis</strong></h3>
<!-- /wp:heading -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Je m'en doutais... </li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Lorsque la VM lenny ne comporte qu'une console... Alors, quand on demande à QEMU d'exécuter SOS ça ratatouille un peu côté affichage. En effet, dans ce cas, QEMU met à la disposition de l'OS un affichage ncurses. De son côté SOS manque encore un peu de subtilité et attaque directement l'affichage vidéo via son mapping mémoire. Voir la dernière capture d'écran par exemple.</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Afin de lever le doute, voilà ce que j'ai fait.</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:heading {"level":4} -->
<h4 class="wp-block-heading"><strong>Duplication de la VM lenny128</strong></h4>
<!-- /wp:heading -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Copie du répertoire <code>lenny128</code></li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Je renomme la copie <code>lenny128X</code></li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Le nom c'est juste pour dire qu'on va passer sous système de fenêtrage</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Dans VMware Player, faire apparaître la VM <code>lenny128X</code></li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Dans ses settings <!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Lui donner 8 ou 4 GB de mémoire</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Lui donner le nom <code>lenny128X</code> </li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Mettre en place un répertoire partagé avec le host Mint. J'ai appelé ce répertoire <code>shared_lenny128X</code></li>
<!-- /wp:list-item --></ul>
<!-- /wp:list --></li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Je lance la VM <code>lenny128X</code></li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Je confirme que c'est une VM que j'ai copié</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Quand je suis sur le terminal je tape les commandes suivantes</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:loos-hcb/code-block -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-plain"><code>sudo apt-get install xorg kde-core --no-install-recommends
startx</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Du coup on a un KDE minimal</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Sous KDE, j'ouvre un terminal où je tape</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:loos-hcb/code-block -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-plain"><code>cd /mnt/hgfs/shared_lenny128X
wget -P ./ http://sos.enix.org/wiki-fr/upload/SOSDownload/sos-code-art2.tgz 
tar -xvf sos-code-art2.tgz
cd sos-code-article2</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Mise à jour des variables <code>grub_dirs_common</code> et <code>sbin_grub_path</code> du fichier <code>../sos-code-article1/support/build-image.sh</code>.  </li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:loos-hcb/code-block -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-plain"><code># grub_dirs_common= .................
# sbin_grub_path= .................

grub_dirs_common=&quot;/usr/local/lib/grub/i386-pc&quot;
sbin_grub_path=&quot;/usr/local/sbin&quot;
</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Build et run</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:loos-hcb/code-block -->
<div class="hcb_wrap"><pre class="prism undefined-numbers lang-plain"><code>make
qemu -fda fd.img</code></pre></div>
<!-- /wp:loos-hcb/code-block -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Tadaaa !</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:image {"align":"center","id":12746,"width":"768px","sizeSlug":"large","linkDestination":"media"} -->
<figure class="wp-block-image aligncenter size-large is-resized"><a href="https://www.40tude.fr/wp-content/uploads/2023/12/article2_fonctionne.png"><img src="https://www.40tude.fr/wp-content/uploads/2023/12/article2_fonctionne-1024x690.png" alt="" class="wp-image-12746" style="width:768px"/></a><figcaption class="wp-element-caption">C'est Noël, ça clignote de partout !</figcaption></figure>
<!-- /wp:image -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>On retrouve bien tous nos petits. Les exceptions à gauche en rouge et les IRQ du compteur en vert à droite. Ça clignote, c'est beau... En ces temps de préparation de Noyel me voilà tout "émouvé".</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Sérieux, je suis super content. Je vais pouvoir comparer des pommes avec des pommes (SOS2 vs SOS) et ne pas perdre de temps avec QEMU en mode console dans une VM.</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Ah oui, sinon, pour arrêter SOS... Comme d'habitude maintenant, j'ouvre une nouvelle console, j'invoque la commande <code>top</code>. Ensuite je tape "<code>k</code>" puis le N° du PID de qemu. Enfin je reviens sur la console où j'avais appelé QEMU.</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>Conclusion</strong></h2>
<!-- /wp:heading -->

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li><s>Il faut que je relise et que je rajoute des captures d'écran. Ca manque.</s></li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li><s>Il faut que je comprenne mieux ces histoires de mémoire vidéo sur QEMU qui tourne lui même dans une VM...</s></li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Tout ceci me confirme qu'en 2023 c'est de la perte de temps que de s'entêter à faire ce genre de truc. Grub 1 (aka Grub Legacy) n'existe plus, tout le monde est en Grub 2, ma Mint "normale" a des inodes de 256 octets... Bref, il n'y a plus grand chose qui matche.</li>
<!-- /wp:list-item -->

<!-- wp:list-item -->
<li>Par contre dans mon cas c'est nécessaire car j'ai besoin de pouvoir comparer SOS à SO2 (la version qui tourne sur Docker, via Grub 2 et dont l'assembleur est en NASM)</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

<!-- wp:paragraph -->
<p><em>Allez, à plus et la suite au prochain épisode... Ce sera quand le code de l'épisode 2 tournera dans SOS2 aussi bien que celui-là. J'y suis presque, il manque juste (yaka, faukon) les exceptions que je loupe complètement.</em></p>
<!-- /wp:paragraph -->