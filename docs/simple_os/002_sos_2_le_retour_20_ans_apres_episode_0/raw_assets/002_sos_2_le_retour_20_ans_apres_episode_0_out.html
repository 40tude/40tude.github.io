---
layout: default    
title: "SOS 2 le retour 20 ans apr√®s‚Ä¶ Episode 0"
math: mathjax
date: 2023-11-30 16:19:20
last_modified_date: 2023-12-05 21:58:13
---


<!-- wp:paragraph -->
<p>J'explique ici la gal√®re que c'est, en 2023, de remonter une machine susceptible de faire tourner le code d'un OS √©crit en 2004. </p>
<!-- /wp:paragraph -->
--div align="center">
--img src="./assets/image-1.webp" alt="" width="900" loading="lazy"/>
--/div>
<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>Intro</strong></h2>
<!-- /wp:heading -->
<!-- wp:paragraph -->
<p>Commence par lire <a href="https://www.40tude.fr/sos-2-le-retour-20-ans-apres/" rel="noreferrer noopener" target="_blank">cet article (√©pisode 1)</a> avant de revenir ici car j'ai √©crit l'√©pisode 1 avant celui-ci. Ay√©, t'as lu? Donc maintenant tu sais que j'ai d√©cid√© de faire du bouche-√†-bouche √† un code qui a une vingtaine d'ann√©e et de le faire tourner dans un setup modernis√© √† base de Grub2, Docker, NASM etc. </p>
<!-- /wp:paragraph -->
<!-- wp:paragraph -->
<p>So far so good... √Ä l'issue de mon premier billet, le code de l'√©pisode 1 tourne et c'est le sourire aux l√®vres que je m'attaque au code de l'√©pisode 2 de la <a href="http://sos.enix.org/fr/SOSDownload" rel="noreferrer noopener" target="_blank">saga SOS</a>. Ce dernier concerne les interruptions (exceptions et IRQ). L√† aussi, √ßa se passe plut√¥t bien et assez rapidement j'ai un code qui "marchotte". Je dis "marchotte" car si les IRQ mat√©rielles du timer sont bien prises en compte, je passe compl√®tement √† c√¥t√© des exceptions (entre autres la division par 0 qui est mise en ≈ìuvre dans le code de d√©monstration de l'article). J'ai beau chercher je ne trouve pas... Je vois bien un ou deux trucs dans mon code mais globalement je suis sec... Finalement j'en arrive √† la <em>tr√®s mauvaise id√©e</em> qu'il serait judicieux de remonter une machine de l'√©poque. Le principe serait d'y faire tourner le code "canal historique", sans y toucher du tout et de voir comment √ßa se passe.</p>
<!-- /wp:paragraph -->
<!-- wp:paragraph -->
<p>Je confirme, c'√©tait une tr√®s mauvaise id√©e et je m'en vais te raconter ici ce qui m'est arriv√©. Je vais tout d√©tailler mais franchement je ne te conseille pas de le refaire de ton c√¥t√©. De mon point de vue, il est tr√®s int√©ressant et instructif de refaire tourner le code de SOS mais il vaut mieux le faire dans un setup "moderne". √Ä toi de voir. Sur ce, allez, c'est parti...</p>
<!-- /wp:paragraph -->
<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>La m√©thode</strong></h2>
<!-- /wp:heading -->
--div align="center">
--img src="./assets/image-38.webp" alt="" loading="lazy"/>
--/div>
<!-- wp:paragraph -->
<p>Je ne peux pas porter le code de SOS sur une disquette. Je n'ai plus de PC avec disquette. √Ä la maison, le seul qui accepte encore les floppy c'est un Mac Classic II mais bon, c'est une autre histoire. En plus, dans la s√©rie SOS, on ne peut utiliser des disquettes que sur les √©pisodes 1 et 2. Bref, √ßa ne vaut pas le coup. </p>
<!-- /wp:paragraph -->
<!-- wp:paragraph -->
<p>Je ne peux pas porter le code sur une machine sur laquelle tourne une distribution moderne. En effet, cette derni√®re utilise Grub 2 comme bootloader. Or le code original de SOS n'est compatible qu'avec Grub 1 (aussi connu sous le nom Grub Legacy). En plus on est dans un contexte 64 bit, faudrait un cross-compiler... √áa ne sent pas la s√©r√©nit√©...</p>
<!-- /wp:paragraph -->
<!-- wp:paragraph -->
<p>J'ai essay√©, vraiment essay√© d'utiliser une image Docker mais je me suis retrouv√© rapidement face √† des probl√®mes de version de Grub 2 vs Grub Legacy, des soucis de compilateur trop r√©cent, des probl√®mes dans le Makefile qui passait plus... En plus, il y a un mixte entre l'image qui peut √™tre de type 386 et le sous-jacent du container qui est "moderne". L√†, je ne suis pas s√ªr de tout comprendre. Bref, j'ai essay√©, j'ai pass√©/perdu beaucoup de temps et finalement je me dis qu'il vaut mieux √©muler une configuration mat√©rielle et logicielle "historique".</p>
<!-- /wp:paragraph -->
<!-- wp:heading {"level":3} -->
<h3 class="wp-block-heading"><strong>Note</strong> </h3>
<!-- /wp:heading -->
<!-- wp:paragraph -->
<p>Compte tenu de ce que j'ai appris avec les tests ci-dessous... Un jour de pluie, je ferai peut-√™tre un nouveau test avec une image Docker. √Ä voir... </p>
<!-- /wp:paragraph -->
<!-- wp:paragraph -->
<p>Comme je manque de PC, je vais installer une "vieille" distribution dans une machine virtuelle "vieille" qui sera √©mul√©e √† l'aide de VMware Workstation 17 Player (s√©rieux, t'as vu la longueur du nom... Ils ont fum√© quoi au marketing ?). Je d√©cide de faire tout √ßa sur un host Linux sur lequel tourne une Mint 21.2 (cela ne change pas grand-chose √† mon avis si on met l'√©mulateur VMware sur un host WIN11).</p>
<!-- /wp:paragraph -->
<!-- wp:paragraph -->
<p>Pour me mettre dans les conditions de l'article originel, il me faut donc une distribution Linux de l'√©poque. En 2004 chez Debian on avait Woody. Je suis parti avec une Lenny, qui est sortie en 2009 car, sauf erreur de ma part c'est la <a href="https://wiki.debian.org/Grub" rel="noreferrer noopener" target="_blank">derni√®re version de Debian qui avait un Grub 1 comme bootloader</a> (ensuite ils sont pass√© sur Grub 2). Je pense que tout ce qui va √™tre expliqu√© ci-dessous peut s'appliquer √† une version Woody mais bon, franchement, je ne souhaite pas r√©it√©rer l'exp√©rience.</p>
<!-- /wp:paragraph -->
<!-- wp:paragraph -->
<p>Donc jusque-l√† c'est simple : </p>
<!-- /wp:paragraph -->
<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Un portable qui fonctionne sous Mint 21.2</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Installation d'un player VMware</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Installation d'une Debian Lenny en tant que VM dans le player</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->
<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>Installer VMware sur le host Mint</strong></h2>
<!-- /wp:heading -->
<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>C'est r√©cent, hyper facile. No problemo</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Si besoin lire <a href="https://linuxways.net/mint/how-to-install-vmware-workstation-on-linux-mint-20/" rel="noreferrer noopener" target="_blank">https://linuxways.net/mint/how-to-install-vmware-workstation-on-linux-mint-20/</a></li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->
<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>R√©cup√©rer une image ISO de Lenny</strong></h2>
<!-- /wp:heading -->
<!-- wp:list -->
<ul><!-- wp:list-item -->
<li><a href="https://cdimage.debian.org/mirror/cdimage/archive/5.0.10/i386/iso-cd/" rel="noreferrer noopener" target="_blank">https://cdimage.debian.org/mirror/cdimage/archive/5.0.10/i386/iso-cd/</a></li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Choisir <code>debian-5010-i386-netinst.iso</code></li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Copie dans <code>/home/philippe/T√©l√©chargements</code> du host Mint</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->
<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>Cr√©er une machine virtuelle lenny</strong> </h2>
<!-- /wp:heading -->
<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Sous VMware Player c'est √©vident. </li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Tout laisser par d√©faut sauf le disque qu'on garde en un seul fichier. </li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->
--div align="center">
--img src="./assets/settings2.webp" alt="" loading="lazy"/>
--/div>
<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Oui, bien s√ªr, avant de lancer la VM, il faut faire pointer le CD de la VM vers le fichier ISO qu'on vient de r√©cup√©rer.</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->
--div align="center">
--img src="./assets/settings1.webp" alt="" width="900" loading="lazy"/>
--/div>
<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Lancer la VM</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->
<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>Installation de Debian Lenny</strong></h2>
<!-- /wp:heading -->
<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Tout laisser par d√©faut (<code>lenny</code> au lieu de <code>debian</code> comme nom de machine)</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Installer SANS miroir (plus rien n'est dispo depuis l'installeur). Faut appuyer sur <strong>ESC</strong> pour sauter cette √©tape et finir l'installation en installant le minimum minimorum. </li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->
--div align="center">
--img src="./assets/mirroir.webp" alt="" loading="lazy"/>
--/div>
<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>On est gentil on confirme qu'on sait (plus ou moins) ce que l'on fait</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->
--div align="center">
--img src="./assets/miroir2.webp" alt="" loading="lazy"/>
--/div>
<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>√Ä la fin, on a donc un syst√®me minimum dans la VM.</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Je passe les d√©tails mais √† la fin, comme la chenille, c'est la VM qui red√©marre üéµüé∂.</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->
<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>Quand on est logu√© sur la VM lenny</strong></h2>
<!-- /wp:heading -->

```bash
su                                          # il n'y a pas encore de sudo
nano /etc/apt/sources.list
```

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Lire <a href="https://www.debian.org/distrib/archive" rel="noreferrer noopener" target="_blank">https://www.debian.org/distrib/archive</a></li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Mettre en commentaire ou <strong>supprimer la ligne</strong> <code>deb cdrom ...</code></li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Ajouter la ligne ci-dessous :</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

```bash
deb http://archive.debian.org/debian-archive/debian/ lenny main contrib non-free
```

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>CTRL + O pour √©crire</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>CTRL + X pour quitter nano</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->
--div align="center">
--img src="./assets/nano1.webp" alt="" loading="lazy"/>
--/div>
<!-- wp:paragraph -->
<p>On est toujours super user. Si on fait un : </p>
<!-- /wp:paragraph -->

```bash
apt-get update
```

<!-- wp:paragraph -->
<p>On a un message qui dit que certaines cl√©s sont expir√©es</p>
<!-- /wp:paragraph -->

```bash
KEYEXPIRED 1520281423
KEYEXPIRED 1337087218
```

<!-- wp:paragraph -->
<p>Je n'ai pas r√©ussi √† mettre √† jour les cl√©s. Par exemple, les 2 commandes ci-dessous n'aident pas.</p>
<!-- /wp:paragraph -->

```bash
apt-key list
apt-key adv --recv-keys --keyserver keyserver.ubuntu.com F42584E6
```

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Lire : <a href="https://futurestud.io/tutorials/fix-ubuntu-debian-apt-get-keyexpired-the-following-signatures-were-invalid" rel="noreferrer noopener" target="_blank">https://futurestud.io/tutorials/fix-ubuntu-debian-apt-get-keyexpired-the-following-signatures-were-invalid</a></li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Faire une recherche sur <code>KEYEXPIRED apt-key</code></li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->
<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>Installer les softs sur la VM lenny</strong></h2>
<!-- /wp:heading -->
<!-- wp:heading {"level":3} -->
<h3 class="wp-block-heading"><strong>M√©thode que j'utilise finalement</strong></h3>
<!-- /wp:heading -->
<!-- wp:paragraph -->
<p>On peut ne <strong>PAS</strong> changer la date de la VM et laisser <code>apt-get install</code> r√¢ler et nous demander de confirmer qu'on veut faire l'installation sans v√©rification (authentification).</p>
<!-- /wp:paragraph -->
<!-- wp:heading {"level":3} -->
<h3 class="wp-block-heading"><strong>Changer la date de la VM</strong> </h3>
<!-- /wp:heading -->
<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Lire <a href="https://stackoverflow.com/questions/29070471/gpg-error-http-archive-debian-org-lenny-updates-release-the-following-signat" rel="noreferrer noopener" target="_blank">https://stackoverflow.com/questions/29070471/gpg-error-http-archive-debian-org-lenny-updates-release-the-following-signat</a></li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Outre le fait que c'est un peu "bourrin" comme m√©thode il faut, en plus, se rappeler √† chaque fois qu'on relance la VM de changer la date. Finalement ce n'est pas tenable. </li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Enfin bref, j'ai essay√©, j'ai eu des probl√®mes... Je ne recommande pas. </li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

```bash
su
date --set "2009-10-10"
apt-get update
apt-get upgrade
```

<!-- wp:heading {"level":3} -->
<h3 class="wp-block-heading"><strong>Les soft √† installer</strong></h3>
<!-- /wp:heading -->

```bash
apt-get install sudo
visudo
```

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Quand <code>apt-get</code> r√¢le parce que le paquet <code>sudo</code> n'a pas √©t√© authentifi√© faut appuyer sur <code>o</code></li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Dans le fichier qui s'ouvre sous nano, rajouter une ligne du style <code>nom_user ALL=‚Ä¶</code> comme pour <code>root</code>. </li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>On sauve CTRL+O</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>On quitte CTRL+X</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

```bash
exit                                      # pour ne plus √™tre root
sudo apt-get install locate
sudo updatedb
```

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Ce n'est peut-√™tre pas une bonne id√©e que de vouloir optimiser en mettant tout dans une m√™me commande.</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Je ne mets pas <code>-y</code> pour bien tout confirmer moi-m√™me √† chaque fois</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

```bash
sudo apt-get install build-essential
sudo apt-get install linux-headers-$(uname -r)
sudo apt-get install mtools
sudo apt-get install file
sudo apt-get install qemu
```

<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>Installer les VMTools</strong></h2>
<!-- /wp:heading -->
<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Faut le faire car je veux un r√©pertoire partag√© entre le host Mint et la VM lenny</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Menu Virtual Machine (en haut de la fen√™tre) </li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Cliquer alors sur VMware Tools Installation</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Revenir dans la console de la VM lenny</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

```bash
sudo mount /dev/cdrom /cdrom
ls /cdrom
```

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>On voit <code>VMwareTools-10.0.12-14792880.tar.gz</code></li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Normalement on est dans <code>$HOME</code></li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Saisir les commandes ci-dessous :</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

```bash
cd
mkdir tmp
cd tmp
tar -xvf /cdrom/VMwareTools-10.0.12-14792880.tar.gz
cd vmware-tools-distrib
sudo ./vmware-install.pl
```

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Garder tous les choix par d√©faut (<code>ENTER</code>, <code>ENTER</code>...)</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Quand c'est termin√©</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

```bash
cd
rm -rf ./tmp/vmware-tools-distrib/
sudo shutdown -h now
```

<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>Faire une copie de la VM</strong> </h2>
<!-- /wp:heading -->
<!-- wp:heading {"textAlign":"center","level":3} -->
<h3 class="wp-block-heading has-text-align-center"><strong>--- /Z!\ Copie de la VM ---</strong></h3>
<!-- /wp:heading -->
<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>C'est tr√®s important car en cas de plantage total de la VM on sera bien content de pouvoir repartir d'une copie. Oui, je te confirme, √ßa sent le v√©cu...</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Si la VM s'appelle <code>lenny</code> et que je m'appelle <code>philippe</code> elle est dans : <code>/home/philippe/vmware/lenny</code> (<code>~/vmware/lenny</code> pour les intimes)</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Suffit de copier le r√©pertoire <code>lenny</code> et de le nommer <code>lenny.bak</code> par exemple</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Ne pas faire appara√Ætre <code>lenny.bak</code> dans le player VMware</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>En cas de souci :<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>On supprime la VM lenny de VMware Workstation Player</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>On fait une copie de <code>lenny.bak</code> qu'on renomme <code>lenny</code></li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>On la fait apparaitre dans VMware Workstation Player</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Le co√ªt par VM n'est pas √©norme. 1.3 GB environ.</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list --></li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->
<!-- wp:paragraph -->
<p><strong>Ne pas passer √† la suite</strong> sans avoir fait une copie. Aie confiance, crois en moi...üéµüé∂</p>
<!-- /wp:paragraph -->
<!-- wp:heading {"textAlign":"center","level":3} -->
<h3 class="wp-block-heading has-text-align-center"><strong>--- /Z!\ Copie de la VM ---</strong></h3>
<!-- /wp:heading -->
<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>Installer un r√©pertoire partag√©</strong></h2>
<!-- /wp:heading -->
<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Entre le host Mint et la VM lenny</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Dans VMware Workstation Player, clic droit sur la VM, option Virtual Machine Settings puis onglet Options</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Lors de la config je nomme le r√©pertoire <code>shared_lenny</code> et il pointe sur le r√©pertoire /<code>home/philippe/Documents/tmp/shared_lenny</code> du host Mint.</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>C'est un truc tout b√™te mais √ßa permet d'√©diter du code avec le VSCode du host Mint plut√¥t qu'avec le nano de la VM lenny etc. </li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->
<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>R√©cup√©rer le code de l'article 1</strong></h2>
<!-- /wp:heading -->
<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Relancer la VM lenny</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Sur la VM, le r√©pertoire partag√© est dans <code>/mnt/hgfs/shared_lenny</code> (c'est tellement intuitif... J'adore ce genre de truc...).</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

```bash
cd /mnt/hgfs/shared_lenny
wget -P ./ http://sos.enix.org/wiki-fr/upload/SOSDownload/sos-code-art1.tgz
tar -xvf sos-code-art1.tgz
cd sos-code-article1
```

<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>Compiler le code de SOS</strong></h2>
<!-- /wp:heading -->

```bash
make
```

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Pas d'erreur</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Un warning dans <code>main.c</code> ligne 32, variable <code>i</code> non utilis√©e. </li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>On s'en fout pour l'instant</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->
<!-- wp:paragraph -->
<p>Sur la VM lenny, si dans la console je tape :</p>
<!-- /wp:paragraph -->

```bash
file fd.img
```

<!-- wp:paragraph -->
<p>Alors je vois :</p>
<!-- /wp:paragraph -->

```bash
fd.img: DOS floppy 1440k, x86 hard disk boot sector
```

<!-- wp:paragraph -->
<p>Comme la compilation a √©t√© faite dans un r√©pertoire partag√© entre le host Mint et la VM lenny, on peut relancer la m√™me commande <code>file fd.img</code> depuis le host. Voil√† ce que l'on voit alors :</p>
<!-- /wp:paragraph -->

```bash
fd.img: DOS/MBR boot sector, code offset 0x48+2, OEM-ID "MTOO3911", root entries 224, sectors 2880 (volumes &lt;=32 MB), sectors/FAT 9, sectors/track 18, serial number 0x78a5cd31, unlabeled, FAT (12 bit), followed by FAT
```

<!-- wp:paragraph -->
<p>Que ce soit sur le host Mint ou la VM lenny, la commande <code>file sos.elf</code> retourne la m√™me chose : </p>
<!-- /wp:paragraph -->

```bash
fsos.elf: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), statically linked, not stripped
```

<!-- wp:paragraph -->
<p>Sur le host Mint, on peut monter l'image <code>fd.img</code>. Suffit de cliquer sur le nom du fichier dans "l'explorateur de fichiers" (je sais plus comment il s'appelle. Nemo ? Pas s√ªr...). On retrouve les sous-r√©pertoires <code>/boot</code>, /<code>modules</code>, /<code>system</code>. Dans <code>/system</code> il y a <code>sos.elf</code>. </p>
<!-- /wp:paragraph -->
<!-- wp:paragraph -->
<p>On peut aussi monter <code>fd.img</code> depuis la VM lenny</p>
<!-- /wp:paragraph -->

```bash
sudo mkdir /media/tmp_dsk
sudo mount -o loop fd.img /media/tmp_dsk
ls -al /media/tmp_dsk
```

<!-- wp:paragraph -->
<p>On retrouve bien le contenu du floppy</p>
<!-- /wp:paragraph -->

```bash
sudo umount /media/tmp_dsk
```

<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>Lancement</strong></h2>
<!-- /wp:heading -->
<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>On est toujours dans le r√©pertoire <code>/mnt/hgfs/shared_lenny/sos-code-article1</code></li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

```bash
qemu -fda fd.img
```

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>On a une erreur du type :</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

```bash
Use fbdev option or set FRAMEBUFFER environment variable
```

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Il faudrait peut-√™tre que je creuse la question apr√®s avoir lu √ßa par exemple : <a href="https://linux.debian.user.narkive.com/HxaW9M7S/fbdev-requirement-of-qemu" rel="noreferrer noopener" target="_blank">https://linux.debian.user.narkive.com/HxaW9M7S/fbdev-requirement-of-qemu</a></li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Normalement SOS fonctionne avec la m√©moire vid√©o qui est mapp√©e en m√©moire (0xB8000, 80x25x2).</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Bon allez, on relance en √©vitant le frame buffer</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

```bash
qemu --curses -fda fd.img
```

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>On voit Grub Ver 0.97 tout en haut de l'√©cran et le menu Simple OS (c'est rassurant, c'est la preuve qu'on est  en Grub 1).</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Apr√®s s√©lection de SOS dans le menu √ßa part en vrille</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

```bash
Booting 'Simple OS'
root (fd0)
Filesystem type is fat, using whole disk
kernel /system/sos.elf
Error 13 : Invalid or unsupported executable format
Press any key to continue...
```

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>L√†, c'est mort</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Sur la VM, il faut ouvrir un second terminal (ALT+F2)</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Se loguer</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Saisir</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

```bash
top
```

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Appuyer sur '<code>k</code>'</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Donner le N¬∞ du PID de qemu puis saisir '9' pour le type de signal √† envoyer</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>C'est √©quivalent √† la commande : <code>kill -9 2684  # o√π 2684 est le PID de qemu</code></li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->
--div align="center">
--img src="./assets/image-39.webp" alt="" loading="lazy"/>
--/div>
<!-- wp:paragraph -->
<p>Bon, ben, "√ßa passe pas...". Va falloir trouver autre chose. </p>
<!-- /wp:paragraph -->
<!-- wp:paragraph -->
<p>Je pensais avoir trouv√© un truc gr√¢ce √† ce lien :</p>
<!-- /wp:paragraph -->
<!-- wp:list -->
<ul><!-- wp:list-item -->
<li><a href="https://stackoverflow.com/questions/27939316/bochs-2-4-6-grub-0-97-error-13-invalid-or-unsupported-executable-format-wh" rel="noreferrer noopener" target="_blank">https://stackoverflow.com/questions/27939316/bochs-2-4-6-grub-0-97-error-13-invalid-or-unsupported-executable-format-wh</a></li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->
<!-- wp:paragraph -->
<p>Dans <code>sos.ldS</code> je d√©place <code>*(.rodata)</code> dans la section <code>.text</code> du code. </p>
<!-- /wp:paragraph -->

```bash
rm -rf sos-code-article1/
tar -xvf sos-code-art1.tgz
```

<!-- wp:paragraph -->
<p>Mouai... Et on fait quoi maintenant qu'on est revenu au point de d√©part ?</p>
<!-- /wp:paragraph -->
<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>Follow the white rabbit...</strong></h2>
<!-- /wp:heading -->
<!-- wp:paragraph -->
<p>Heu... Je vais te calmer tout de suite. On ne va pas aller aux pays des merveilles mais plut√¥t √† la cave... Et encore, je vais te donner une version √©dulcor√©e, un truc bien propre, √† la chronologie bien lin√©aire, genre tuto de YouTube o√π tout se passe toujours bien. </p>
<!-- /wp:paragraph -->
<!-- wp:paragraph -->
<p>En r√©alit√© √ßa ne s'est pas du tout pass√© comme √ßa. C'est parti dans tous les sens, j'ai pas mal cherch√©, j'ai fait les trucs dans le mauvais ordre, j'ai perdu pas mal de VM... Une vraie boucherie, y avait du sang partout. Le genre d'exp√©rience qui te donne envie de tout jeter. Un peu comme les ces püíÄt@ins de randos qui n'en finissent pas de monter...</p>
<!-- /wp:paragraph -->
<!-- wp:embed {"url":"https://www.youtube.com/shorts/d92jbkVY8wY","type":"video","providerNameSlug":"youtube","responsive":true,"className":"wp-embed-aspect-16-9 wp-has-aspect-ratio"} -->
<figure class="wp-block-embed is-type-video is-provider-youtube wp-block-embed-youtube wp-embed-aspect-16-9 wp-has-aspect-ratio"><div class="wp-block-embed__wrapper">
https://www.youtube.com/shorts/d92jbkVY8wY
</div></figure>
<!-- /wp:embed -->
<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>Ce que je crois avoir compris</strong></h2>
<!-- /wp:heading -->
<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>SOS fonctionne avec Grub 1</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Dans la configuration actuelle, avec le Grub 1 install√© sur la VM lenny, le Makefile retrouve bien ses petits mais √ßa part en vrille √† l'ex√©cution. Message du style "Invalid or unsupported executable format".</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>En cherchant sur le web, je fini par fouiller, √† la main, message par message, dans les <a href="http://the-doors.enix.org/pipermail/sos/">archives de la mailing </a><a href="http://the-doors.enix.org/pipermail/sos/" rel="noreferrer noopener" target="_blank">l</a><a href="http://the-doors.enix.org/pipermail/sos/">ist de SOS</a> (merci les gars, franchement merci de tout laisser en ligne apr√®s autant d'ann√©es) </li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Plus pr√©cis√©ment, je tombe sur ce message : <a href="http://the-doors.enix.org/pipermail/sos/2011-January/001076.html" rel="noreferrer noopener" target="_blank">http://the-doors.enix.org/pipermail/sos/2011-January/001076.html</a>. L√†, tu te dis qu'il y a des mecs qui ont plus d'id√©es que toi et qu'il y a peut-√™tre un truc √† tenter.</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Du coup je recompile un Grub 1 et je l'installe sur la VM lenny</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Ensuite je recompile SOS. √áa g√©n√®re un nouveau fichier fd.img en utilisant, entre autres, le fichier Stage 2 du "nouveau" Grub 1</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Et l√†... √áa ne marche toujours pas... PüíÄt@in fait suer !!!</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Grand moment de solitude... Pas le moral... Je tombe dans l'alcool, la drogue et la prostitution...</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Mais bon, en continuant √† chercher je trouve ce billet : <a href="https://wiki.archlinux.org/title/Talk:GRUB_Legacy">https://wiki.archlinux.org/title/Talk:GRUB_Legacy</a></li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->
--div align="center">
--img src="./assets/image.webp" alt="" loading="lazy"/>
--/div>
<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>L√†, tu comprends que pour Grub 1, il faut que les <a href="https://fr.wikipedia.org/wiki/N%C5%93ud_d%27index" rel="noreferrer noopener" target="_blank">inodes du syst√®me de fichiers</a> aient une taille de 128 octets.</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->
<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Bien s√ªr, quand je v√©rifie la taille des inodes de la VM lenny je d√©couvre qu'ils ont une taille de 256 octets. C'est bizarre et contradictoire avec ce qui est dit dans le billet mais bon... On va quand m√™me essayer de mettre les inodes √† 128 octets.</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Le probl√®me c'est que je ne peux pas changer la taille des inodes sur un disque qui est mont√©</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Je r√©cup√®re une distribution qui poss√®de un mode "live". </li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Je boote la VM lenny sur le CD de la distribution live en question</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Je v√©rifie la taille des inodes. Ils sont √† 256 bytes.</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Je demande √† les faire passer √† 128...</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Et l√† on me dit que ce n'est pas possible de r√©duire la taille des inodes qu'on ne peut que les faire grandir</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>PüíÄt@in, je suis maudit ou quoi ?</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Re alcool, re drogue et re prostitution...</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>J'essaie de jouer avec l'installeur de la Debian Lenny. J'essaie le mode expert mais l√† il y a trop de questions auxquelles je n'ai pas les r√©ponses. Je pense cependant qu'un "bon" aurait choisi cette voie. </li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Finalement je fais un entre-deux un peu "cracra". Accroche ta ceinture et reste avec moi deux minutes. Imagine... :<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Je boote le live CD sur la VM leny</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Cette derni√®re a toutes ses partitions, tout va bien. Y a juste la premi√®re dont il faut faire passer la taille des inodes de 256 √† 128 octets</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>On sacrifie la premi√®re partition en claquant dessus un nouveau syst√®me de fichiers dont les inodes ont une taille de 128. √áa ne va sans doute pas matcher au niveau de la taille de la partition mais on s'en fout on est plus √† √ßa pr√®s. </li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Par contre, c'est s√ªr, on aura perdu tous les fichiers. </li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Faut donc refaire une installation de la Debian Lenny</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Je reboote donc la VM lenny avec le CD d'installation de la Debian Lenny</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Lors du param√©trage de l'installation on demande √† garder les partitions ainsi que les syst√®mes de fichiers en place et √† simplement copier les fichiers de Lenny dessus</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Enfin je reboote la VM lenny. </li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Tout devrait √™tre pareil sauf que dor√©navant, les inodes de sda1 devraient √™tre √† 128 octets.</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list --></li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Pour faire bonne mesure, je recompile un Grub 1 et je le r√©installe</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Je reboote de la VM lenny</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Je compile et je teste SOS </li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Et si √ßa ne marche pas... Ben je ne sais pas... J'√©l√®ve des brebis sur les hauteurs de <a href="https://www.sarisolenzara.fr/" rel="noreferrer noopener" target="_blank">Solenzara </a>? </li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->
<!-- wp:paragraph -->
<p>Mouai... √áa a l'air compliqu√© ton affaire. Tu peux r√©sumer ?</p>
<!-- /wp:paragraph -->
<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>La check-list qu'on va suivre</strong></h2>
<!-- /wp:heading -->
<!-- wp:list {"ordered":true} -->
<ol><!-- wp:list-item -->
<li>R√©cup√©rer une distribution "live" et booter dessus</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Cr√©er un syst√®me de fichiers avec des inodes √† 128 octets sur le sda1 de la VM</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Rebooter la VM sur le CD d'installation Debian Lenny</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Refaire une installation en conservant les syst√®mes de fichiers en place</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Rebooter la VM, compiler et installer Grub 1</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Rebooter la VM, compiler et tester SOS</li>
<!-- /wp:list-item --></ol>
<!-- /wp:list -->
<!-- wp:paragraph -->
<p>Ca a l'air tellement facile, tellement naturel quand c'est r√©sum√© de cette fa√ßon...</p>
<!-- /wp:paragraph -->
<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>1 - R√©cup√©rer une distribution live et booter dessus</strong></h2>
<!-- /wp:heading -->
<!-- wp:list {"ordered":true} -->
<ol><!-- wp:list-item -->
<li>Apr√®s coup je pense que j'aurai pu prendre une BusyBox, une ToyBox o√π un truc de ce genre. Sur le moment je n'ai pas r√©fl√©chi, j'ai fait simple et j'ai r√©cup√©r√© une <a href="https://www.linuxmint.com/edition.php?id=307" rel="noreferrer noopener" target="_blank">Mint XFCE</a> parce que c'est pas trop lourd, que je sais qu'il y a <code>gparted</code> etc. </li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Je la d√©pose dans le r√©pertoire <code>/home/philippe/T√©l√©chargements</code> du host Mint</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Je fais une copie du r√©pertoire <code>/home/philippe/vmware/lenny</code> que je renomme <code>/home/philippe/vmware/lenny128</code> (128 comme les 128 octets des inodes. Malin le mec ü¶ä)  </li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Je fais appara√Ætre cette VM dans VMware Player (un clic sur home puis "Open a Virtual Machine" √† droite). </li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Dans les settings je fais passer la m√©moire √† 4GB et je fais pointer le CD sur l'ISO de Mint XFCE. </li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>J'en profite pour cr√©er un r√©pertoire partag√© que je nomme <code>shared-lenny128</code>. Sur le host Mint il pointe sur /<code>home/philippe/Documents/tmp/shared_lenny128</code></li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Au d√©marrage de la VM je confirme que j'ai copi√© la VM (c'est pour des histoires de duplication d'adresse MAC, je sais plus trop).</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Concernant le d√©marrage sur le CD live il faut, quand la VM boote, appuyer sur la touche <code>F2</code> pour acc√®der √† son BIOS. L√†, dans l'onglet boot du BIOS, il faut mettre le CD en haut de la liste, quitter le BIOS et reprendre le d√©marrage de la VM. </li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>On se retrouve sur une Mint XFCE live </li>
<!-- /wp:list-item --></ol>
<!-- /wp:list -->
<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>2 - Cr√©er un syst√®me de fichiers avec des inodes √† 128 octets sur le sda1 de la VM</strong></h2>
<!-- /wp:heading -->
<!-- wp:list {"ordered":true} -->
<ol><!-- wp:list-item -->
<li>J'utilise l'excellent <code>gparted</code> de la Mint live et je v√©rifie les diff√©rentes partitions du disque ainsi que le nom de ce dernier. Ici c'est sda, la partition swap est sur sda5 et le syst√®me de fichiers sur sda1</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Dans un terminal, pour v√©rifier la taille des inodes je tape : <code>sudo tune2fs -l /dev/sda1</code></li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Dans tout ce qui est affich√© je vois un truc du style : <code>Inode size 256</code></li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Pour v√©rifier la taille des inodes on peut aussi faire un <code>cat /etc/mk2fs.conf | more</code></li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Ca va pas marcher mais on peut tenter : <code>sudo tune2fs -I 128 /dev/sda1</code></li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>C'est l√† qu'il r√©pond : <code>tune2fs 1.46.5 (30 Dec 2020) Shrinking inode size not supported</code></li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Pas de remord, on pas trop d'autre solution. On cr√©√© un nouveau syst√®me de fichiers sur la partition sda1 avec : <code>sudo mke2fs -t ext3 -I 128 /dev/sda1</code></li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>On √©teint gentiment la VM (<code>sudo shutdown -h now</code>) et on revient sur le VMware Player</li>
<!-- /wp:list-item --></ol>
<!-- /wp:list -->
<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>3 - Rebooter la VM sur le CD d'installation Debian Lenny</strong></h2>
<!-- /wp:heading -->
<!-- wp:list {"ordered":true} -->
<ol><!-- wp:list-item -->
<li>Dans le VMware Player je m'assure que le CD de la VM lenny128 pointe bien sur l'ISO <code>debian-5010-i386-netinst.iso</code></li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>On red√©marre la VM</li>
<!-- /wp:list-item --></ol>
<!-- /wp:list -->
<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>4 - Refaire une installation en conservant les syst√®mes de fichiers en place</strong></h2>
<!-- /wp:heading -->
<!-- wp:list {"ordered":true} -->
<ol><!-- wp:list-item -->
<li>On commence √† avoir l'habitude</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Je laisse tout par defaut sauf que je nomme la machine lenny128</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Le truc le plus important c'est l'√©tape partition/syst√®me de fichiers. Faut lui faire comprendre qu'on garde le partitionnment et le syst√®me de fichiers qui est en place</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>On passe √† la suite et il copie les fichiers</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>L'installation se termine normalement</li>
<!-- /wp:list-item --></ol>
<!-- /wp:list -->
<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>5 - Rebooter la VM, compiler et installer Grub 1</strong></h2>
<!-- /wp:heading -->
<!-- wp:list {"ordered":true} -->
<ol><!-- wp:list-item -->
<li>Une fois que la VM lenny128 a d√©marr√©, je tape <code>sudo tune2fs -l /dev/sda1</code> dans un terminal</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Je dois voir un truc du style <code>Inode size : 128</code>. Si je n'ai pas cette valeur, c'est pas la peine d'aller plus loin. Il faut revenir en arri√®re. </li>
<!-- /wp:list-item --></ol>
<!-- /wp:list -->
<!-- wp:heading {"level":3} -->
<h3 class="wp-block-heading"><strong>5.1 - Compiler Grub 1</strong></h3>
<!-- /wp:heading -->

```plain
sudo nano /etc/apt/sources.lst
```

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Ajouter la ligne</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

```plain
deb-src http://archive.debian.org/debian-archive/debian/ lenny main 
```

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Sauver, quitter. Normalement il y a un r√©pertoire <code>tmp</code> dans <code>$HOME</code></li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

```plain
sudo apt-get update
cd ~/tmp
mkdir grub_build
cd grub_build
apt-get source grub
cd grub-0.97
```

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Allez, on compile et on installe. <br/>Pas de panique √ßa va bien se passer. En fait on a d√©j√† t√©l√©charg√© tout ce dont a besoin (rappelle toi le <code>sudo apt-get install build-essential</code> par exemple). <br/>Ensuite le make install ne va rien installer sur l'installation d√©j√† en place. En fait tous les fichiers g√©n√©r√©s vont se retrouver dans <code>/usr/local</code>. Donc, encore une fois, pas de panique.   </li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

```plain
./configure
make                    # jette ton ≈ìil
make -n install         # jette ton ≈ìil, v√©rifie que tout semble OK
sudo make install

```

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Quand c'est termin√© et que tout semble s'√™tre bien pass√©</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

```plain
ls -al /usr/local/sbin
ls -al /usr/local/lib/grub/i386-pc
```

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>√Ä titre d'exercice je te propose de comparer les tailles, les dates et les heures des fichiers <code>stage2</code> des r√©pertoires <code>/boot/grub</code> et <code>/usr/local/lib/grub/i386-pc</code>. </li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Moi j'ai respectivement 128 552 octets d'un c√¥t√© et 101 978 de l'autre. </li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Ce qu'il faut qu'on fasse maintenant c'est qu'on installe notre Grub 1 nouvellement compil√© en lieu et place de celui qui est venu avec la Debian Lenny.</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>On v√©rifie le petit nom de notre disque avec cette commande par exemple</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

```plain
sudo fdisk -l
```

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Moi je vois <code>sda1</code>‚Ä¶ <code>sda5</code>. Mon disque s'appelle <code>sda</code>. </li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Ensuite j'installe le nouveau Grub1.</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

```plain
cd /usr/local/sbin
sudo ./grub-install /dev/sda
```

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Aucune erreur √† l'√©cran normalement. </li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Si c'est pas le cas on est mal... </li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Dans <code>/boot/grub</code> je vois que la taille de stage2 est dor√©navant 101 978. </li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>On reboote</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

```plain
sudo reboot -h now
```

<!-- wp:heading {"level":3} -->
<h3 class="wp-block-heading"><strong>5.2 √Ä lire si besoin</strong></h3>
<!-- /wp:heading -->
<!-- wp:list -->
<ul><!-- wp:list-item -->
<li><a href="https://www.gnu.org/software/grub/manual/grub/html_node/Installing-GRUB-using-grub_002dinstall.html" rel="noreferrer noopener" target="_blank">https://www.gnu.org/software/grub/manual/grub/html_node/Installing-GRUB-using-grub_002dinstall.html</a></li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li><a href="https://www.cyberciti.biz/faq/how-to-get-source-code-of-package-using-the-apt-command-on-debian-or-ubuntu/" rel="noreferrer noopener" target="_blank">https://www.cyberciti.biz/faq/how-to-get-source-code-of-package-using-the-apt-command-on-debian-or-ubuntu/</a></li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li><a href="https://www.malekal.com/comment-compiler-un-logiciel-depuis-des-sources-sur-linux/" rel="noreferrer noopener" target="_blank">https://www.malekal.com/comment-compiler-un-logiciel-depuis-des-sources-sur-linux/</a></li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->
<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>6 - Rebooter la VM, compiler et tester SOS</strong></h2>
<!-- /wp:heading -->
<!-- wp:heading {"level":3} -->
<h3 class="wp-block-heading"><strong>6.1 Article 1 de SOS</strong></h3>
<!-- /wp:heading -->
<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Oups... On a d√©j√† reboot√©. <br/>Tiens, vas-y, fais moi un proc√®s si t'es pas content.</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>On r√©cupr√®re ensuite le code de l'article 1 de SOS. </li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

```plain
cd /mnt/hgfs/shared_lenny128
wget -P ./ http://sos.enix.org/wiki-fr/upload/SOSDownload/sos-code-art1.tgz 
tar -xvf sos-code-art1.tgz
cd sos-code-article1

```

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Comme on a recompil√© Grub 1 je te propose de mettre √† jour les variables <code>grub_dirs_common</code> et <code>sbin_grub_path</code> du fichier <code>../sos-code-article1/support/build-image.sh</code> comme suit :  </li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

```plain
# grub_dirs_common= .................
# sbin_grub_path= .................

grub_dirs_common="/usr/local/lib/grub/i386-pc"
sbin_grub_path="/usr/local/sbin"

```

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Quand c'est fait on build. </li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Il ne doit pas y avoir d'erreur. Il y a juste un warning √† propos d'une variable <code>i</code> qui n'est pas utilis√©e dans <code>main.c</code>.</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

```plain
make
```

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>On boote SOS dans QEMU</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Note que je demande √† l'√©mulateur QEMU de simuler une machine avec 256 MB de RAM mais bon on s'en fout... </li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Oh, püíÄt@in √ßa d√©marre enfin ! </li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

```plain
qemu -m 256M --curses -fda fd.img
```

--div align="center">
--img src="./assets/article1.webp" alt="" loading="lazy"/>
--/div>
<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Je pense que les probl√®mes d'affichage sont li√©s au fait que QEMU est en mode "curses" (√ßa ressemble √† Rhide et √† l'interface graphique qu'avait <a href="https://winworldpc.com/product/borland-turbo-c/2x" rel="noreferrer noopener" target="_blank">Turbo C 2.0</a>) et que cela ne correspond pas exactement √† la repr√©sentation que SOS se fait de la m√©moire vid√©o. </li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Faut regarder dans le d√©tail. Je ne suis pas s√ªr de tout comprendre. </li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Mais... Nom de Zeus, Marty, il a d√©marr√© !</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->
<!-- wp:paragraph -->
<p>Pour sortir proprement, il faut :</p>
<!-- /wp:paragraph -->
<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Ouvrir un second terminal (ALT+F2)</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Se loguer</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Saisir la commande <code>top</code></li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Appuyer sur '<code>k</code>'</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Donner le N¬∞ du PID de qemu puis saisir '9' pour le type de signal √† envoyer</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->
<!-- wp:heading {"level":4} -->
<h4 class="wp-block-heading"><strong>6.1.1 √Ä lire si besoin</strong></h4>
<!-- /wp:heading -->
<!-- wp:list -->
<ul><!-- wp:list-item -->
<li><a href="https://fr.wikipedia.org/wiki/Ncurses#:~:text=ncurses%20(de%20l'anglais%20%C2%AB,'un%20mode%20semi%2Dgraphique." rel="noreferrer noopener" target="_blank">https://fr.wikipedia.org/wiki/Ncurses#:~:text=ncurses%20(de%20l'anglais%20%C2%AB,'un%20mode%20semi%2Dgraphique.</a></li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li><a href="https://arnaud-feltz.developpez.com/tutoriels/ncurses/?page=premier_pas" rel="noreferrer noopener" target="_blank">https://arnaud-feltz.developpez.com/tutoriels/ncurses/?page=premier_pas</a></li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->
<!-- wp:heading {"level":3} -->
<h3 class="wp-block-heading"><strong>6.2 Article 2 de SOS</strong></h3>
<!-- /wp:heading -->
<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Je te la fais courte</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

```plain
cd /mnt/hgfs/shared_lenny128
wget -P ./ http://sos.enix.org/wiki-fr/upload/SOSDownload/sos-code-art2.tgz 
tar -xvf sos-code-art2.tgz
cd sos-code-article2
```

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Mise √† jour des variables <code>grub_dirs_common</code> et <code>sbin_grub_path</code> du fichier <code>../sos-code-article1/support/build-image.sh</code>.  </li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

```plain
# grub_dirs_common= .................
# sbin_grub_path= .................

grub_dirs_common="/usr/local/lib/grub/i386-pc"
sbin_grub_path="/usr/local/sbin"

```

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Build et run</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

```plain
make
qemu -m 256M --curses -fda fd.img
```

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Voil√† ce que je vois.</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->
--div align="center">
--img src="./assets/article2.webp" alt="" loading="lazy"/>
--/div>
<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Comme dans l'article 2 on retrouve des marques rouges √† gauche pour les exceptions li√©es aux divisions par 0. </li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Cependant, je ne retrouve pas √† droite les marques vertes qui comptent les IRQ mat√©rielles du timer qui tourne √† 100 Hz. </li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>M'en fout. Je suis trop content, je regarderai √ßa plus tard. Je suis presque s√ªr que c'est un probl√®me d'affichage, de maping m√©moire... </li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->
<!-- wp:heading {"level":3} -->
<h3 class="wp-block-heading"><strong>6.3 Article 2 de SOS, bis</strong></h3>
<!-- /wp:heading -->
<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Je m'en doutais... </li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Lorsque la VM lenny ne comporte qu'une console... Alors, quand on demande √† QEMU d'ex√©cuter SOS √ßa ratatouille un peu c√¥t√© affichage. En effet, dans ce cas, QEMU met √† la disposition de l'OS un affichage ncurses. De son c√¥t√© SOS manque encore un peu de subtilit√© et attaque directement l'affichage vid√©o via son mapping m√©moire. Voir la derni√®re capture d'√©cran par exemple.</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Afin de lever le doute, voil√† ce que j'ai fait.</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->
<!-- wp:heading {"level":4} -->
<h4 class="wp-block-heading"><strong>Duplication de la VM lenny128</strong></h4>
<!-- /wp:heading -->
<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Copie du r√©pertoire <code>lenny128</code></li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Je renomme la copie <code>lenny128X</code></li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Le nom c'est juste pour dire qu'on va passer sous syst√®me de fen√™trage</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Dans VMware Player, faire appara√Ætre la VM <code>lenny128X</code></li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Dans ses settings <!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Lui donner 8 ou 4 GB de m√©moire</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Lui donner le nom <code>lenny128X</code> </li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Mettre en place un r√©pertoire partag√© avec le host Mint. J'ai appel√© ce r√©pertoire <code>shared_lenny128X</code></li>
<!-- /wp:list-item --></ul>
<!-- /wp:list --></li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Je lance la VM <code>lenny128X</code></li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Je confirme que c'est une VM que j'ai copi√©</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Quand je suis sur le terminal je tape les commandes suivantes</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

```plain
sudo apt-get install xorg kde-core --no-install-recommends
startx
```

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Du coup on a un KDE minimal</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Sous KDE, j'ouvre un terminal o√π je tape</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

```plain
cd /mnt/hgfs/shared_lenny128X
wget -P ./ http://sos.enix.org/wiki-fr/upload/SOSDownload/sos-code-art2.tgz 
tar -xvf sos-code-art2.tgz
cd sos-code-article2
```

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Mise √† jour des variables <code>grub_dirs_common</code> et <code>sbin_grub_path</code> du fichier <code>../sos-code-article1/support/build-image.sh</code>.  </li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

```plain
# grub_dirs_common= .................
# sbin_grub_path= .................

grub_dirs_common="/usr/local/lib/grub/i386-pc"
sbin_grub_path="/usr/local/sbin"

```

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Build et run</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->

```plain
make
qemu -fda fd.img
```

<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Tadaaa !</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->
--div align="center">
--img src="./assets/article2_fonctionne.webp" alt="" width="900" loading="lazy"/>
--/div>
<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>On retrouve bien tous nos petits. Les exceptions √† gauche en rouge et les IRQ du compteur en vert √† droite. √áa clignote, c'est beau... En ces temps de pr√©paration de Noyel me voil√† tout "√©mouv√©".</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>S√©rieux, je suis super content. Je vais pouvoir comparer des pommes avec des pommes (SOS2 vs SOS) et ne pas perdre de temps avec QEMU en mode console dans une VM.</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Ah oui, sinon, pour arr√™ter SOS... Comme d'habitude maintenant, j'ouvre une nouvelle console, j'invoque la commande <code>top</code>. Ensuite je tape "<code>k</code>" puis le N¬∞ du PID de qemu. Enfin je reviens sur la console o√π j'avais appel√© QEMU.</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->
<!-- wp:heading -->
<h2 class="wp-block-heading"><strong>Conclusion</strong></h2>
<!-- /wp:heading -->
<!-- wp:list -->
<ul><!-- wp:list-item -->
<li><s>Il faut que je relise et que je rajoute des captures d'√©cran. Ca manque.</s></li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li><s>Il faut que je comprenne mieux ces histoires de m√©moire vid√©o sur QEMU qui tourne lui m√™me dans une VM...</s></li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Tout ceci me confirme qu'en 2023 c'est de la perte de temps que de s'ent√™ter √† faire ce genre de truc. Grub 1 (aka Grub Legacy) n'existe plus, tout le monde est en Grub 2, ma Mint "normale" a des inodes de 256 octets... Bref, il n'y a plus grand chose qui matche.</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Par contre dans mon cas c'est n√©cessaire car j'ai besoin de pouvoir comparer SOS √† SO2 (la version qui tourne sur Docker, via Grub 2 et dont l'assembleur est en NASM)</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->
<!-- wp:paragraph -->
<p><em>Allez, √† plus et la suite au prochain √©pisode... Ce sera quand le code de l'√©pisode 2 tournera dans SOS2 aussi bien que celui-l√†. J'y suis presque, il manque juste (yaka, faukon) les exceptions que je loupe compl√®tement.</em></p>
<!-- /wp:paragraph -->